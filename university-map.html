<!DOCTYPE html>
<html>
<head>
    <title>Interactive University of Hull Map</title>
    <style>
        /* Main map container */
        #map {
            height: 100vh;
            width: 100%;
            transition: margin-left 0.3s ease;
        }
        
        /* Updated Navigation panel */
        #controls {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 900;
            background: rgba(255,255,255,0.98);
            width: 300px;
            height: 100vh;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        #controls.active {
            transform: translateX(0);
        }
        
        /* Updated Hamburger Menu */
        #menu-toggle {
            position: fixed;
            left: 15px;
            top: 15px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        #menu-toggle:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }
        
        #menu-toggle span {
            display: block;
            width: 20px;
            height: 2px;
            background: #00509E;
            position: relative;
            transition: all 0.3s ease;
        }
        
        #menu-toggle span:before,
        #menu-toggle span:after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background: #00509E;
            transition: all 0.3s ease;
        }
        
        #menu-toggle span:before {
            top: -6px;
        }
        
        #menu-toggle span:after {
            top: 6px;
        }
        
        #menu-toggle.active span {
            background: transparent;
        }
        
        #menu-toggle.active span:before {
            transform: rotate(45deg);
            top: 0;
        }
        
        #menu-toggle.active span:after {
            transform: rotate(-45deg);
            top: 0;
        }

        /* Scenario panels */
        .scenario-panel {
            display: none;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        /* Accessibility markers */
        .accessibility-marker {
            background-color: #2ECC71;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        /* Emergency markers */
        .emergency-marker {
            background-color: #E74C3C;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* Alert banner */
        #alert-banner {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,204,0,0.9);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10;
            display: none;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Route Info Panel */
        #route-info-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10;
            display: none;
            max-width: 90%;
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .route-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .route-time {
            font-size: 18px;
            font-weight: bold;
            color: #00509E;
        }
        
        .route-distance {
            font-size: 14px;
            color: #666;
        }
        
        .route-steps {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .route-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .route-step:last-child {
            border-bottom: none;
        }
        
        .step-icon {
            margin-right: 10px;
            font-size: 18px;
            color: #00509E;
        }
        
        .step-text {
            flex: 1;
            font-size: 14px;
        }
        
        .step-distance {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        
        /* Animation for the route path */
        .animate-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 3s linear forwards;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* Enhanced Location Styling */
        .user-location-dot {
            width: 16px;
            height: 16px;
            background-color: #4285F4;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .accuracy-circle {
            fill: #4285F4;
            fill-opacity: 0.2;
            stroke: #4285F4;
            stroke-opacity: 0.4;
            stroke-width: 1;
        }
        
        @keyframes location-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulsing-dot {
            animation: location-pulse 2s infinite;
        }

        /* Keep all your existing styles */
        #search-container {
            margin-bottom: 15px;
        }
        #search-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            display: none;
        }
        #directions-panel {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            display: none;
        }
        .category {
            color: #00509E;
            font-weight: bold;
            margin: 15px 0 5px 0;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        button:hover {
            background: #00509E;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #logo {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #00509E;
            font-size: 1.1em;
        }
        #recenter-btn, #reset-directions, #show-location, #toggle-satellite {
            background: #00509E;
            color: white;
            text-align: center;
        }
        .search-result {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        .search-result:hover {
            background: #f0f7ff;
            transform: translateX(5px);
        }
        .mode-selector {
            margin: 10px 0;
        }
        .mode-btn {
            display: inline-block;
            width: auto;
            padding: 5px 10px;
            margin-right: 5px;
        }
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            display: none;
        }
        .building-label {
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 3px #000;
            padding: 2px 5px;
            background-color: rgba(0, 80, 158, 0.7);
            border-radius: 3px;
        }
        .mode-toggle {
            background: #00509E;
            color: white;
            text-align: center;
            margin: 5px 0;
        }
        
        /* New Social Features */
        .friend-marker {
            background-color: #4285F4;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .social-point {
            background-color: #34A853;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .meetup-marker {
            background-color: #FBBC05;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        /* High contrast mode */
        .high-contrast {
            filter: contrast(1.2);
            --primary-color: #000000;
            --secondary-color: #ffffff;
            --accent-color: #ffff00;
        }
        
        .high-contrast #map {
            background-color: #000;
        }
        
        .high-contrast .building-label {
            color: #ffff00 !important;
            background-color: #000 !important;
            text-shadow: 1px 1px 3px #000 !important;
        }
        
        /* Loading skeletons */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Time-aware features */
        .closed-building {
            opacity: 0.6;
            filter: grayscale(50%);
        }
        
        /* Multi-stop routes */
        .stop-marker {
            background-color: #EA4335;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        /* Weather effects */
        .rain-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><line x1="10" y1="10" x2="20" y2="40" stroke="rgba(0,80,158,0.2)" stroke-width="1"/><line x1="30" y1="15" x2="40" y2="45" stroke="rgba(0,80,158,0.2)" stroke-width="1"/><line x1="50" y1="5" x2="60" y2="35" stroke="rgba(0,80,158,0.2)" stroke-width="1"/><line x1="70" y1="20" x2="80" y2="50" stroke="rgba(0,80,158,0.2)" stroke-width="1"/><line x1="90" y1="10" x2="100" y2="40" stroke="rgba(0,80,158,0.2)" stroke-width="1"/></svg>');
            opacity: 0.3;
            animation: rainAnimation 0.5s linear infinite;
        }
        
        @keyframes rainAnimation {
            from { background-position: 0 0; }
            to { background-position: 0 100px; }
        }
        
        /* Seasonal themes */
        .autumn-leaf {
            position: absolute;
            width: 15px;
            height: 15px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,10 C60,30 80,40 90,50 C80,60 60,70 50,90 C40,70 20,60 10,50 C20,40 40,30 50,10 Z" fill="%23E67E22"/></svg>');
            pointer-events: none;
            animation: fallingLeaf linear infinite;
        }
        
        @keyframes fallingLeaf {
            0% { transform: translate(0, -10px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translate(100px, 100vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Updated Hamburger menu -->
    <button id="menu-toggle" aria-label="Toggle navigation menu">
        <span></span>
    </button>
    
    <!-- Navigation Panel -->
    <div id="controls">
        <div id="logo">UNIVERSITY OF HULL</div>
        
        <!-- Search Box -->
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search buildings...">
            <div id="search-results"></div>
        </div>
        
        <button id="recenter-btn">Reset View</button>
        <button id="show-location">Show My Location</button>
        <button id="toggle-satellite">Toggle Satellite View</button>
        <button id="reset-directions" style="display:none;">Clear Directions</button>
        
        <!-- New Social Features Button -->
        <button id="toggle-social">Find Friends</button>
        
        <!-- New High Contrast Toggle -->
        <button id="high-contrast-toggle">High Contrast Mode</button>
        
        <!-- Directions Panel -->
        <div id="directions-panel">
            <div class="mode-selector">
                <button class="mode-btn" data-mode="WALKING">Walk</button>
                <button class="mode-btn" data-mode="DRIVING">Drive</button>
            </div>
            <div id="distance-info"></div>
            <div id="directions-instructions"></div>
            
            <!-- Multi-stop routes -->
            <div id="multi-stop-container" style="display: none; margin-top: 10px;">
                <button id="add-stop-btn">Add Stop</button>
                <div id="stops-list"></div>
                <button id="optimize-route-btn">Optimize Route</button>
            </div>
        </div>
        
        <!-- Scenario Selection -->
        <div class="category">MAP SCENARIOS</div>
        <button id="scenario-student" class="mode-toggle">Student Mode</button>
        <button id="scenario-accessibility" class="mode-toggle">Accessibility</button>
        <button id="scenario-emergency" class="mode-toggle">Emergency</button>
        
        <!-- Student Scenario Panel -->
        <div id="student-panel" class="scenario-panel">
            <input type="text" id="room-search" placeholder="Enter course code (e.g. CS101)">
            <div id="room-results"></div>
            
            <!-- Class schedule integration -->
            <div class="category" style="margin-top: 15px;">MY SCHEDULE</div>
            <div id="class-schedule">
                <div class="schedule-item" data-building="WIL-01" data-room="WB101">
                    <strong>CS101</strong> - 10:00-11:00 (Mon/Wed)
                </div>
                <div class="schedule-item" data-building="LAR-01" data-room="LK203">
                    <strong>BIO201</strong> - 14:00-15:00 (Tue/Thu)
                </div>
            </div>
        </div>
        
        <!-- Accessibility Scenario Panel -->
        <div id="accessibility-panel" class="scenario-panel">
            <label>
                <input type="checkbox" id="wheelchair-route" checked> 
                Wheelchair accessible routes only
            </label>
            <label>
                <input type="checkbox" id="avoid-stairs" checked> 
                Avoid stairs
            </label>
            
            <!-- Personalized routing -->
            <div class="category" style="margin-top: 15px;">PERSONALIZED ROUTING</div>
            <label>
                <input type="checkbox" id="prefer-covered"> 
                Prefer covered routes
            </label>
            <label>
                Walking Speed:
                <select id="walking-speed">
                    <option value="slow">Slow</option>
                    <option value="medium" selected>Medium</option>
                    <option value="fast">Fast</option>
                </select>
            </label>
        </div>
        
        <!-- Emergency Scenario Panel -->
        <div id="emergency-panel" class="scenario-panel">
            <button id="find-security">Find Security Office</button>
            <button id="find-medical">Find Medical Help</button>
            <button id="emergency-call">Call Campus Security</button>
            
            <!-- Emergency meeting points -->
            <div class="category" style="margin-top: 15px;">EMERGENCY MEETING POINTS</div>
            <button class="emergency-meeting-point" data-lat="53.771000" data-lng="-0.368000">Main Quad</button>
            <button class="emergency-meeting-point" data-lat="53.770500" data-lng="-0.367000">Library Plaza</button>
        </div>
        
        <!-- Social Points of Interest -->
        <div id="social-panel" class="scenario-panel">
            <div class="category">POPULAR SPOTS</div>
            <button class="social-spot" data-lat="53.771500" data-lng="-0.368500" data-type="study">
                Best Study Spot (Library 3rd Floor)
            </button>
            <button class="social-spot" data-lat="53.771800" data-lng="-0.367200" data-type="hangout">
                Student Hangout (Courtyard Café)
            </button>
            <button class="social-spot" data-lat="53.770900" data-lng="-0.366500" data-type="shortcut">
                Hidden Shortcut (Wilberforce to Larkin)
            </button>
            
            <div class="category" style="margin-top: 15px;">ADD NEW SPOT</div>
            <input type="text" id="new-spot-name" placeholder="Spot name">
            <select id="new-spot-type">
                <option value="study">Study Spot</option>
                <option value="hangout">Hangout</option>
                <option value="shortcut">Shortcut</option>
                <option value="other">Other</option>
            </select>
            <button id="add-spot-btn">Add Current Location</button>
        </div>
        
        <!-- Building Categories -->
        <div class="category">ACADEMIC BUILDINGS</div>
        <button class="goto-btn" data-lat="53.771112" data-lng="-0.369320">Brynmor Jones Library</button>
        <button class="goto-btn" data-lat="53.770998" data-lng="-0.370300">Allam Medical Building</button>
        <button class="goto-btn" data-lat="53.770821" data-lng="-0.366477">Wilberforce Building</button>
        <button class="goto-btn" data-lat="53.770330" data-lng="-0.368166">Larkin Building</button>
        <button class="goto-btn" data-lat="53.771509" data-lng="-0.368860">Robert Blackburn</button>
        
        <div class="category">STUDENT LIFE</div>
        <button class="goto-btn" data-lat="53.772666" data-lng="-0.365194">Masjid Hull University</button>
        <button class="goto-btn" data-lat="53.771961" data-lng="-0.366254">Student Union (Asylum)</button>
        <button class="goto-btn" data-lat="53.771715" data-lng="-0.366143">Wetherspoons (Sanctuary)</button>
        
        <div class="category">ACCOMMODATIONS</div>
        <button class="goto-btn" data-lat="53.772658" data-lng="-0.366401">The Courtyard</button>
        <button class="goto-btn" data-lat="53.771534" data-lng="-0.372415">Westfield Court</button>
        <button class="goto-btn" data-lat="53.770757" data-lng="-0.364416">Taylor Court</button>
        
        <div class="category">SPORTS</div>
        <button class="goto-btn" data-lat="53.774024" data-lng="-0.368526">Allam Sports Centre</button>
        
        <!-- Time-aware features -->
        <div class="category">FACILITY HOURS</div>
        <div id="facility-hours">
            <div class="facility-hour" data-building="LIB-01">
                <strong>Library:</strong> 8:00-22:00 (Mon-Fri), 10:00-18:00 (Sat-Sun)
            </div>
            <div class="facility-hour" data-building="MED-01">
                <strong>Medical Center:</strong> 9:00-17:00 (Mon-Fri)
            </div>
            <div class="facility-hour" data-building="SPO-01">
                <strong>Sports Centre:</strong> 6:00-22:00 (Mon-Fri), 8:00-20:00 (Sat-Sun)
            </div>
        </div>
    </div>

    <div id="map"></div>
    <div id="alert-banner"></div>
    <div id="debug-info"></div>
    
    <!-- Route Info Panel -->
    <div id="route-info-container">
        <div class="route-info-header">
            <div class="route-time" id="route-duration">-</div>
            <div class="route-distance" id="route-length">-</div>
        </div>
        <div class="route-steps" id="route-steps">
            <!-- Steps will be inserted here by JavaScript -->
        </div>
    </div>
    
    <!-- Weather overlay -->
    <div id="weather-overlay" class="rain-overlay" style="display: none;"></div>
    
    <!-- Seasonal elements container -->
    <div id="seasonal-elements"></div>

    <script>
        // Boundary coordinates (invisible crop)
        const BOUNDARY_COORDS = [
            { lat: 53.776447, lng: -0.371282 }, // NW
            { lat: 53.772511, lng: -0.374911 }, // NE
            { lat: 53.769470, lng: -0.371443 }, // SE
            { lat: 53.769553, lng: -0.366529 }, // SW
            { lat: 53.770662, lng: -0.362849 }, // Additional
            { lat: 53.776204, lng: -0.365295 }  // Additional
        ];

        // Global variables
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocationMarker;
        let selectedBuilding = null;
        let isSatelliteView = false;
        let currentScenario = null;
        let alertMarkers = [];
        let accessibilityMarkers = [];
        let emergencyMarkers = [];
        let currentRoutePolyline = null;
        let watchPositionId = null;
        let accuracyCircle = null;
        let friendMarkers = [];
        let socialMarkers = [];
        let meetupMarker = null;
        let meetupTimer = null;
        let routeStops = [];
        let currentSeason = 'autumn'; // Can be 'autumn', 'winter', 'spring', 'summer'
        let currentWeather = 'clear'; // Can be 'clear', 'rain', 'snow'

        // Enhanced buildings data with rooms and hours
        const BUILDINGS = [
            {
                id: "LIB-01",
                title: "Brynmor Jones Library",
                lat: 53.771112,
                lng: -0.369320,
                color: "#00509E",
                category: "Academic",
                rooms: ["LB101", "LB202", "LB305"],
                accessibility: {
                    wheelchair: true,
                    elevator: true
                },
                hours: {
                    weekdays: { open: 8, close: 22 },
                    weekends: { open: 10, close: 18 },
                    exceptions: []
                },
                hasCoveredAccess: true
            },
            {
                id: "MED-01",
                title: "Allam Medical Building",
                lat: 53.770998,
                lng: -0.370300,
                color: "#00509E",
                category: "Academic",
                rooms: ["AM101", "AM201"],
                accessibility: {
                    wheelchair: true,
                    elevator: true
                },
                hours: {
                    weekdays: { open: 9, close: 17 },
                    weekends: null, // Closed on weekends
                    exceptions: []
                },
                hasCoveredAccess: false
            },
            {
                id: "WIL-01",
                title: "Wilberforce Building",
                lat: 53.770821,
                lng: -0.366477,
                color: "#00509E",
                category: "Academic",
                rooms: ["WB101", "WB201", "WB301"],
                accessibility: {
                    wheelchair: true,
                    elevator: false
                },
                hours: {
                    weekdays: { open: 7, close: 21 },
                    weekends: { open: 9, close: 17 },
                    exceptions: []
                },
                hasCoveredAccess: true
            },
            {
                id: "LAR-01",
                title: "Larkin Building",
                lat: 53.770330,
                lng: -0.368166,
                color: "#00509E",
                category: "Academic",
                rooms: ["LK101", "LK203", "LK205"],
                accessibility: {
                    wheelchair: true,
                    elevator: true
                },
                hours: {
                    weekdays: { open: 8, close: 20 },
                    weekends: null,
                    exceptions: []
                },
                hasCoveredAccess: false
            },
            {
                id: "SPO-01",
                title: "Allam Sports Centre",
                lat: 53.774024,
                lng: -0.368526,
                color: "#00509E",
                category: "Sports",
                rooms: ["GYM", "POOL", "STUDIO1"],
                accessibility: {
                    wheelchair: true,
                    elevator: true
                },
                hours: {
                    weekdays: { open: 6, close: 22 },
                    weekends: { open: 8, close: 20 },
                    exceptions: []
                },
                hasCoveredAccess: true
            }
        ];

        // Emergency facilities
        const EMERGENCY_FACILITIES = [
            {
                id: "SEC-01",
                title: "Security Office",
                lat: 53.771500,
                lng: -0.368500,
                type: "security"
            },
            {
                id: "FIR-01",
                title: "First Aid Station",
                lat: 53.770998,
                lng: -0.370300,
                type: "medical"
            },
            {
                id: "EMP-01",
                title: "Emergency Meeting Point (Main Quad)",
                lat: 53.771000,
                lng: -0.368000,
                type: "meeting"
            },
            {
                id: "EMP-02",
                title: "Emergency Meeting Point (Library Plaza)",
                lat: 53.770500,
                lng: -0.367000,
                type: "meeting"
            }
        ];

        // Class schedule data (example)
        const CLASS_SCHEDULE = [
            {
                code: "CS101",
                building: "WIL-01",
                room: "WB101",
                name: "Introduction to Computer Science",
                days: ["Mon", "Wed"],
                time: { start: "10:00", end: "11:00" }
            },
            {
                code: "BIO201",
                building: "LAR-01",
                room: "LK203",
                name: "Biology Fundamentals",
                days: ["Tue", "Thu"],
                time: { start: "14:00", end: "15:00" }
            }
        ];

        // Teacher alerts
        const TEACHER_ALERTS = [
            {
                id: "ALERT-001",
                buildingId: "WIL-01",
                room: "WB101",
                message: "CS101 moved to Larkin Building Room LK205 today",
                expires: new Date(Date.now() + 86400000).toISOString() // 24 hours from now
            }
        ];

        // Friend data (in a real app, this would come from a server)
        const FRIENDS = [
            { 
                id: 'friend1', 
                name: 'Sarah', 
                avatar: 'S', 
                color: '#FF6B6B', 
                location: { lat: 53.771112, lng: -0.369320 },
                status: 'Studying at the library'
            },
            { 
                id: 'friend2', 
                name: 'Alex', 
                avatar: 'A', 
                color: '#4ECDC4', 
                location: { lat: 53.770998, lng: -0.370300 },
                status: 'At the medical building'
            },
            { 
                id: 'friend3', 
                name: 'Jamie', 
                avatar: 'J', 
                color: '#9B59B6', 
                location: { lat: 53.771961, lng: -0.366254 },
                status: 'Hanging out at the student union'
            }
        ];

        // Social points of interest
        const SOCIAL_POINTS = [
            {
                id: 'spot1',
                title: 'Best Study Spot (Library 3rd Floor)',
                type: 'study',
                lat: 53.771500,
                lng: -0.368500,
                upvotes: 42,
                downvotes: 3,
                description: 'Quiet corner with great natural light and power outlets'
            },
            {
                id: 'spot2',
                title: 'Student Hangout (Courtyard Café)',
                type: 'hangout',
                lat: 53.771800,
                lng: -0.367200,
                upvotes: 35,
                downvotes: 2,
                description: 'Best place to meet friends between classes'
            },
            {
                id: 'spot3',
                title: 'Hidden Shortcut (Wilberforce to Larkin)',
                type: 'shortcut',
                lat: 53.770900,
                lng: -0.366500,
                upvotes: 28,
                downvotes: 1,
                description: 'Saves 5 minutes between these buildings'
            }
        ];

        // Initialize map
        function initMap() {
            // Initialize map with strict boundaries
            const bounds = new google.maps.LatLngBounds();
            BOUNDARY_COORDS.forEach(coord => bounds.extend(coord));

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 53.771, lng: -0.368 },
                zoom: 17,
                mapTypeId: 'hybrid',
                disableDefaultUI: true,
                gestureHandling: "greedy",
                restriction: {
                    latLngBounds: bounds,
                    strictBounds: true
                }
            });

            // Add invisible cropping polygon
            new google.maps.Polygon({
                paths: BOUNDARY_COORDS,
                strokeOpacity: 0,
                fillOpacity: 0,
                map: map
            });

            // Initialize directions services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true, // We'll use our own markers
                preserveViewport: false,
                polylineOptions: {
                    strokeColor: "#00509E",
                    strokeOpacity: 0.8,
                    strokeWeight: 5
                }
            });

            // Add building markers with time-aware status
            BUILDINGS.forEach(building => {
                const isOpen = checkIfBuildingIsOpen(building);
                const marker = new google.maps.Marker({
                    position: { lat: building.lat, lng: building.lng },
                    map: map,
                    title: building.title,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: isOpen ? building.color : "#CCCCCC",
                        fillOpacity: 0.9,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2,
                        scale: 8,
                        optimized: true
                    },
                    zIndex: google.maps.Marker.MAX_ZINDEX + 1
                });

                // Add building labels with hours info
                const nextOpen = getNextOpeningTime(building);
                const labelContent = `
                    <div class="building-label">
                        ${building.title}
                        ${!isOpen ? `<br><small>Closed - Opens ${nextOpen}</small>` : ''}
                    </div>
                `;
                
                const label = new google.maps.InfoWindow({
                    content: labelContent,
                    disableAutoPan: true
                });
                
                marker.addListener("mouseover", () => {
                    label.open(map, marker);
                });
                
                marker.addListener("mouseout", () => {
                    label.close();
                });

                marker.addListener("click", () => {
                    showBuildingInfo(building);
                });
                
                // Add closed class if building is closed
                if (!isOpen) {
                    marker.set("class", "closed-building");
                }
            });

            // Setup UI components
            setupHamburgerMenu();
            setupEventListeners();
            setupScenarios();
            checkTeacherAlerts();
            initAccessibility();
            initMicroInteractions();
            initSocialFeatures();
            initTimeAwareFeatures();
            initMultiStopRoutes();
            initSeasonalEffects();

            // Initial location attempt
            getUserLocation(false);
            
            // Simulate weather (in a real app, this would come from an API)
            simulateWeather();
        }

        function setupHamburgerMenu() {
            const menuToggle = document.getElementById('menu-toggle');
            const controlsPanel = document.getElementById('controls');
            
            // Set initial state
            const panelState = localStorage.getItem('panelState') !== 'closed';
            controlsPanel.classList.toggle('active', panelState);
            menuToggle.classList.toggle('active', panelState);
            
            menuToggle.addEventListener('click', () => {
                const isActive = !controlsPanel.classList.contains('active');
                controlsPanel.classList.toggle('active', isActive);
                menuToggle.classList.toggle('active', isActive);
                localStorage.setItem('panelState', isActive ? 'open' : 'closed');
            });
            
            // Close panel when clicking outside
            document.addEventListener('click', (e) => {
                if (!controlsPanel.contains(e.target) && e.target !== menuToggle) {
                    controlsPanel.classList.remove('active');
                    menuToggle.classList.remove('active');
                    localStorage.setItem('panelState', 'closed');
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    controlsPanel.style.transform = 'translateX(0)';
                    menuToggle.style.display = 'none';
                } else {
                    menuToggle.style.display = 'block';
                    controlsPanel.style.transform = panelState ? 'translateX(0)' : 'translateX(-100%)';
                }
            });
        }

        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.goto-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    const destination = { lat, lng };
                    centerAndPulse(destination, this.textContent);
                });
            });

            // Recenter button
            document.getElementById("recenter-btn").addEventListener("click", resetMap);

            // Show location button
            document.getElementById("show-location").addEventListener("click", () => {
                if (userLocationMarker) {
                    map.panTo(userLocationMarker.getPosition());
                    map.setZoom(18);
                } else {
                    getUserLocation(true);
                }
            });

            // Toggle satellite view
            document.getElementById("toggle-satellite").addEventListener("click", () => {
                isSatelliteView = !isSatelliteView;
                map.setMapTypeId(isSatelliteView ? 'hybrid' : 'roadmap');
                document.getElementById("toggle-satellite").textContent = 
                    isSatelliteView ? "Show Map View" : "Show Satellite View";
            });

            // Reset directions
            document.getElementById("reset-directions").addEventListener("click", resetDirections);

            // Mode selector buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (selectedBuilding) {
                        calculateAndDisplayRoute(selectedBuilding, this.dataset.mode);
                    }
                });
            });

            // Search functionality
            document.getElementById('search-input').addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    document.getElementById('search-results').style.display = 'none';
                    return;
                }
                
                const results = BUILDINGS.filter(building => 
                    building.title.toLowerCase().includes(query)
                );
                
                displaySearchResults(results);
            });
            
            // Class schedule items
            document.querySelectorAll('.schedule-item').forEach(item => {
                item.addEventListener('click', function() {
                    const buildingId = this.getAttribute('data-building');
                    const room = this.getAttribute('data-room');
                    const building = BUILDINGS.find(b => b.id === buildingId);
                    
                    if (building) {
                        const target = new google.maps.LatLng(building.lat, building.lng);
                        centerAndPulse(target, `${building.title}, Room ${room}`);
                        selectedBuilding = building;
                        showDirectionsPanel();
                        
                        // Check if class is about to start
                        checkClassTime(this.textContent);
                    }
                });
            });
            
            // Emergency meeting points
            document.querySelectorAll('.emergency-meeting-point').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    const destination = { lat, lng };
                    centerAndPulse(destination, this.textContent);
                    
                    if (userLocationMarker) {
                        calculateAndDisplayRoute(destination, 'WALKING');
                    }
                });
            });
            
            // Social spots
            document.querySelectorAll('.social-spot').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    const type = this.getAttribute('data-type');
                    const destination = { lat, lng };
                    
                    centerAndPulse(destination, this.textContent);
                    
                    // Show info about this spot
                    const spot = SOCIAL_POINTS.find(s => 
                        s.lat === lat && s.lng === lng
                    );
                    
                    if (spot) {
                        showSocialSpotInfo(spot);
                    }
                });
            });
            
            // Add new spot button
            document.getElementById('add-spot-btn').addEventListener('click', function() {
                if (!userLocationMarker) {
                    alert('Please enable your location first');
                    return;
                }
                
                const name = document.getElementById('new-spot-name').value;
                const type = document.getElementById('new-spot-type').value;
                
                if (!name) {
                    alert('Please enter a name for this spot');
                    return;
                }
                
                // In a real app, this would save to a database
                const newSpot = {
                    id: 'new-' + Date.now(),
                    title: name,
                    type: type,
                    lat: userLocationMarker.getPosition().lat(),
                    lng: userLocationMarker.getPosition().lng(),
                    upvotes: 1,
                    downvotes: 0,
                    description: 'Added by user'
                };
                
                SOCIAL_POINTS.push(newSpot);
                addSocialMarker(newSpot);
                
                alert(`Added new ${type} spot: ${name}`);
                document.getElementById('new-spot-name').value = '';
            });
        }

        function setupScenarios() {
            // Student scenario
            document.getElementById('scenario-student').addEventListener('click', () => {
                toggleScenario('student');
            });
            
            // Accessibility scenario
            document.getElementById('scenario-accessibility').addEventListener('click', () => {
                toggleScenario('accessibility');
                updateAccessibilityMarkers();
            });
            
            // Emergency scenario
            document.getElementById('scenario-emergency').addEventListener('click', () => {
                toggleScenario('emergency');
                updateEmergencyMarkers();
            });
            
            // Social features toggle
            document.getElementById('toggle-social').addEventListener('click', () => {
                toggleScenario('social');
            });
            
            // Room search functionality
            document.getElementById('room-search').addEventListener('input', function() {
                const query = this.value.toUpperCase();
                if (query.length < 2) {
                    document.getElementById('room-results').innerHTML = '';
                    return;
                }
                
                const results = CLASS_SCHEDULE.filter(course => 
                    course.code.includes(query) || 
                    course.room.includes(query)
                );
                
                displayRoomResults(results);
            });
            
            // Find security
            document.getElementById('find-security').addEventListener('click', () => {
                const security = EMERGENCY_FACILITIES.find(f => f.type === 'security');
                if (security) {
                    centerAndPulse({ lat: security.lat, lng: security.lng }, security.title);
                    if (userLocationMarker) {
                        calculateAndDisplayRoute(security, 'WALKING');
                    }
                }
            });
            
            // Find medical
            document.getElementById('find-medical').addEventListener('click', () => {
                const medical = EMERGENCY_FACILITIES.find(f => f.type === 'medical');
                if (medical) {
                    centerAndPulse({ lat: medical.lat, lng: medical.lng }, medical.title);
                    if (userLocationMarker) {
                        calculateAndDisplayRoute(medical, 'WALKING');
                    }
                }
            });
            
            // Emergency call
            document.getElementById('emergency-call').addEventListener('click', () => {
                alert("Calling campus security...\n\nIn a real implementation, this would connect to security services.");
            });
            
            // Accessibility options
            document.getElementById('wheelchair-route').addEventListener('change', updateAccessibilityOptions);
            document.getElementById('avoid-stairs').addEventListener('change', updateAccessibilityOptions);
            document.getElementById('prefer-covered').addEventListener('change', updateAccessibilityOptions);
            document.getElementById('walking-speed').addEventListener('change', updateAccessibilityOptions);
        }

        function initAccessibility() {
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                switch(e.key.toUpperCase()) {
                    case 'M': 
                        document.getElementById('menu-toggle').click();
                        break;
                    case 'S':
                        document.getElementById('search-input').focus();
                        break;
                    case 'L':
                        document.getElementById('show-location').click();
                        break;
                    case 'F':
                        document.getElementById('toggle-social').click();
                        break;
                    case '1':
                        document.getElementById('scenario-student').click();
                        break;
                    case '2':
                        document.getElementById('scenario-accessibility').click();
                        break;
                    case '3':
                        document.getElementById('scenario-emergency').click();
                        break;
                }
            });
            
            // High contrast mode toggle
            document.getElementById('high-contrast-toggle').addEventListener('click', () => {
                document.body.classList.toggle('high-contrast');
                
                // Update map style for high contrast
                const highContrastStyles = [
                    { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#000000" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#ffffff" }] }
                ];
                
                map.setOptions({
                    styles: document.body.classList.contains('high-contrast') ? highContrastStyles : []
                });
                
                // Update button text
                document.getElementById('high-contrast-toggle').textContent = 
                    document.body.classList.contains('high-contrast') ? 'Normal Mode' : 'High Contrast Mode';
            });
            
            // Set focus states for all interactive elements
            document.querySelectorAll('button, input, [tabindex]').forEach(el => {
                el.addEventListener('focus', function() {
                    this.style.outline = '2px solid #00509E';
                    this.style.outlineOffset = '2px';
                });
                
                el.addEventListener('blur', function() {
                    this.style.outline = '';
                });
            });
        }

        function initMicroInteractions() {
            // Button hover effects
            const buttons = document.querySelectorAll('button:not(.mode-btn)');
            buttons.forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 0 10px rgba(0,80,158,0.5)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = '';
                    btn.style.boxShadow = '';
                });
            });
            
            // Menu animations
            const menuItems = document.querySelectorAll('#controls > *');
            menuItems.forEach((item, i) => {
                item.style.opacity = '0';
                item.style.transform = 'translateX(-20px)';
                item.style.transition = `all 0.3s ease ${i * 0.05}s`;
                
                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                }, 100);
            });
            
            // Scenario toggle animations
            document.querySelectorAll('.mode-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 200);
                });
            });
        }

        function initSocialFeatures() {
            // Add friend markers
            FRIENDS.forEach(friend => {
                const marker = new google.maps.Marker({
                    position: friend.location,
                    map: map,
                    title: friend.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: friend.color,
                        fillOpacity: 0.9,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2,
                        scale: 10,
                    },
                    zIndex: google.maps.Marker.MAX_ZINDEX + 3
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding:10px">
                            <h3 style="margin:0">${friend.name}</h3>
                            <p>${friend.status}</p>
                            <p>At ${getBuildingAtLocation(friend.location)?.title || 'Unknown Location'}</p>
                            <button onclick="requestMeetup(${friend.location.lat}, ${friend.location.lng}, '${friend.name}')" 
                                    style="background:#00509E;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px">
                                Meet Here
                            </button>
                            <button onclick="findMidpoint('${friend.id}')" 
                                    style="background:#34A853;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px">
                                Meet Halfway
                            </button>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                friendMarkers.push(marker);
                marker.setMap(null); // Start with markers hidden
            });
            
            // Add social points of interest
            SOCIAL_POINTS.forEach(spot => {
                addSocialMarker(spot);
            });
            
            // Toggle friend visibility
            document.getElementById('toggle-social').addEventListener('click', function() {
                const isActive = this.classList.toggle('active');
                
                if (isActive) {
                    this.textContent = 'Hide Friends';
                    friendMarkers.forEach(marker => marker.setMap(map));
                    socialMarkers.forEach(marker => marker.setMap(map));
                } else {
                    this.textContent = 'Find Friends';
                    friendMarkers.forEach(marker => marker.setMap(null));
                    socialMarkers.forEach(marker => marker.setMap(null));
                    
                    // Also hide any active meetup markers
                    if (meetupMarker) {
                        meetupMarker.setMap(null);
                        meetupMarker = null;
                    }
                    
                    if (meetupTimer) {
                        clearInterval(meetupTimer);
                        meetupTimer = null;
                    }
                }
            });
        }

        function addSocialMarker(spot) {
            let iconColor;
            switch(spot.type) {
                case 'study': iconColor = '#4285F4'; break;
                case 'hangout': iconColor = '#EA4335'; break;
                case 'shortcut': iconColor = '#FBBC05'; break;
                default: iconColor = '#34A853';
            }
            
            const marker = new google.maps.Marker({
                position: { lat: spot.lat, lng: spot.lng },
                map: null, // Start hidden
                title: spot.title,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: iconColor,
                    fillOpacity: 0.9,
                    strokeColor: "#FFFFFF",
                    strokeWeight: 2,
                    scale: 8,
                },
                zIndex: google.maps.Marker.MAX_ZINDEX + 2
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding:10px;max-width:200px">
                        <h3 style="margin:0">${spot.title}</h3>
                        <p>${spot.description}</p>
                        <div style="margin-top:5px;">
                            <span style="color:#34A853">↑${spot.upvotes}</span> 
                            <span style="color:#EA4335">↓${spot.downvotes}</span>
                        </div>
                        <button onclick="navigateToSpot(${spot.lat}, ${spot.lng})" 
                                style="background:#00509E;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px">
                            Navigate Here
                        </button>
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });
            
            socialMarkers.push(marker);
        }

        function initTimeAwareFeatures() {
            // Update building status based on current time
            updateBuildingStatus();
            
            // Check for upcoming classes
            checkUpcomingClasses();
            
            // Set up periodic checks
            setInterval(updateBuildingStatus, 60000); // Every minute
            setInterval(checkUpcomingClasses, 300000); // Every 5 minutes
        }

        function initMultiStopRoutes() {
            document.getElementById('add-stop-btn').addEventListener('click', function() {
                if (!selectedBuilding) {
                    alert('Please select a destination first');
                    return;
                }
                
                routeStops.push({
                    position: new google.maps.LatLng(selectedBuilding.lat, selectedBuilding.lng),
                    title: selectedBuilding.title
                });
                
                updateStopsList();
                document.getElementById('multi-stop-container').style.display = 'block';
            });
            
            document.getElementById('optimize-route-btn').addEventListener('click', function() {
                if (routeStops.length < 2) {
                    alert('Please add at least 2 stops to optimize');
                    return;
                }
                
                calculateMultiStopRoute();
            });
        }

        function initSeasonalEffects() {
            // Set seasonal theme based on current date
            const now = new Date();
            const month = now.getMonth() + 1;
            
            if (month >= 3 && month <= 5) {
                currentSeason = 'spring';
            } else if (month >= 6 && month <= 8) {
                currentSeason = 'summer';
            } else if (month >= 9 && month <= 11) {
                currentSeason = 'autumn';
            } else {
                currentSeason = 'winter';
            }
            
            applySeasonalTheme();
        }

        function simulateWeather() {
            // In a real app, this would come from a weather API
            const weatherTypes = ['clear', 'rain', 'snow'];
            currentWeather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
            
            applyWeatherEffects();
            
            // Change weather periodically (for demo purposes)
            setInterval(() => {
                currentWeather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
                applyWeatherEffects();
            }, 300000); // Every 5 minutes
        }

        function applyWeatherEffects() {
            const weatherOverlay = document.getElementById('weather-overlay');
            
            switch(currentWeather) {
                case 'rain':
                    weatherOverlay.style.display = 'block';
                    weatherOverlay.className = 'rain-overlay';
                    break;
                case 'snow':
                    weatherOverlay.style.display = 'block';
                    weatherOverlay.className = 'snow-overlay';
                    break;
                default:
                    weatherOverlay.style.display = 'none';
            }
            
            // Update routing suggestions based on weather
            if (currentWeather === 'rain' && document.getElementById('prefer-covered').checked) {
                suggestCoveredRoutes();
            }
        }

        function applySeasonalTheme() {
            const seasonalContainer = document.getElementById('seasonal-elements');
            seasonalContainer.innerHTML = '';
            
            switch(currentSeason) {
                case 'autumn':
                    // Add falling leaves
                    for (let i = 0; i < 20; i++) {
                        const leaf = document.createElement('div');
                        leaf.className = 'autumn-leaf';
                        leaf.style.left = Math.random() * 100 + 'vw';
                        leaf.style.animationDuration = (5 + Math.random() * 10) + 's';
                        leaf.style.animationDelay = Math.random() * 5 + 's';
                        seasonalContainer.appendChild(leaf);
                    }
                    break;
                case 'winter':
                    // Could add snowflakes here
                    break;
                case 'spring':
                    // Could add blossom effects here
                    break;
                case 'summer':
                    // Could add sun effects here
                    break;
            }
        }

        function toggleScenario(scenario) {
            // Hide all panels first
            document.querySelectorAll('.scenario-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Reset button colors
            document.querySelectorAll('.mode-toggle').forEach(btn => {
                btn.style.backgroundColor = '#00509E';
            });
            
            // If clicking the same scenario, toggle it off
            if (currentScenario === scenario) {
                currentScenario = null;
                document.getElementById('toggle-social').classList.remove('active');
                document.getElementById('toggle-social').textContent = 'Find Friends';
                friendMarkers.forEach(marker => marker.setMap(null));
                socialMarkers.forEach(marker => marker.setMap(null));
                return;
            }
            
            // Show selected panel
            currentScenario = scenario;
            
            if (scenario === 'social') {
                const panel = document.getElementById('social-panel');
                panel.style.display = 'block';
                document.getElementById('toggle-social').classList.add('active');
                document.getElementById('toggle-social').textContent = 'Hide Friends';
                friendMarkers.forEach(marker => marker.setMap(map));
                socialMarkers.forEach(marker => marker.setMap(map));
            } else {
                const panel = document.getElementById(`${scenario}-panel`);
                panel.style.display = 'block';
                document.getElementById(`scenario-${scenario}`).style.backgroundColor = '#003366';
            }
            
            // Scenario-specific initializations
            switch(scenario) {
                case 'student':
                    document.getElementById('room-search').focus();
                    break;
                case 'accessibility':
                    updateAccessibilityMarkers();
                    break;
                case 'emergency':
                    updateEmergencyMarkers();
                    break;
            }
        }

        function updateAccessibilityMarkers() {
            // Clear existing markers
            accessibilityMarkers.forEach(marker => marker.setMap(null));
            accessibilityMarkers = [];
            
            // Add markers for accessible features
            BUILDINGS.forEach(building => {
                if (building.accessibility.wheelchair) {
                    const content = document.createElement('div');
                    content.className = 'accessibility-marker';
                    content.textContent = '♿ Accessible';
                    
                    const marker = new google.maps.InfoWindow({
                        content: content,
                        position: { lat: building.lat, lng: building.lng },
                        disableAutoPan: true
                    });
                    
                    marker.open(map);
                    accessibilityMarkers.push(marker);
                }
                
                if (building.accessibility.elevator) {
                    const content = document.createElement('div');
                    content.className = 'accessibility-marker';
                    content.textContent = '🛗 Elevator';
                    
                    const marker = new google.maps.InfoWindow({
                        content: content,
                        position: { 
                            lat: building.lat + 0.0001, 
                            lng: building.lng + 0.0001 
                        },
                        disableAutoPan: true
                    });
                    
                    marker.open(map);
                    accessibilityMarkers.push(marker);
                }
            });
        }

        function updateEmergencyMarkers() {
            // Clear existing markers
            emergencyMarkers.forEach(marker => marker.setMap(null));
            emergencyMarkers = [];
            
            // Add markers for emergency facilities
            EMERGENCY_FACILITIES.forEach(facility => {
                let icon, text;
                switch(facility.type) {
                    case 'security':
                        icon = '🚨';
                        text = 'Security';
                        break;
                    case 'medical':
                        icon = '🏥';
                        text = 'Medical';
                        break;
                    case 'meeting':
                        icon = '🟢';
                        text = 'Meeting Point';
                        break;
                }
                
                const content = document.createElement('div');
                content.className = 'emergency-marker';
                content.textContent = `${icon} ${text}`;
                
                const marker = new google.maps.InfoWindow({
                    content: content,
                    position: { lat: facility.lat, lng: facility.lng },
                    disableAutoPan: true
                });
                
                marker.open(map);
                emergencyMarkers.push(marker);
            });
        }

        function updateAccessibilityOptions() {
            const wheelchairOnly = document.getElementById('wheelchair-route').checked;
            const avoidStairs = document.getElementById('avoid-stairs').checked;
            const preferCovered = document.getElementById('prefer-covered').checked;
            const walkingSpeed = document.getElementById('walking-speed').value;
            
            // In a real implementation, you would use these options to modify directions
            console.log(`Accessibility options updated: wheelchair=${wheelchairOnly}, avoidStairs=${avoidStairs}, preferCovered=${preferCovered}, walkingSpeed=${walkingSpeed}`);
            
            // If we have a current route, recalculate with new options
            if (selectedBuilding && userLocationMarker) {
                calculateAndDisplayRoute(selectedBuilding, 'WALKING');
            }
        }

        function checkTeacherAlerts() {
            const now = new Date();
            const activeAlerts = TEACHER_ALERTS.filter(alert => new Date(alert.expires) > now);
            
            if (activeAlerts.length > 0) {
                showAlertBanner(activeAlerts[0].message);
                
                // Highlight affected buildings
                activeAlerts.forEach(alert => {
                    const building = BUILDINGS.find(b => b.id === alert.buildingId);
                    if (building) {
                        // Add pulsing alert marker
                        const alertMarker = new google.maps.Marker({
                            position: { lat: building.lat, lng: building.lng },
                            map: map,
                            title: "Class Change Alert",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: "#FFA500",
                                fillOpacity: 0.8,
                                strokeColor: "#FFFFFF",
                                strokeWeight: 2,
                                scale: 10
                            },
                            zIndex: google.maps.Marker.MAX_ZINDEX + 4,
                            animation: google.maps.Animation.BOUNCE
                        });
                        
                        alertMarkers.push(alertMarker);
                        
                        // Remove after 10 seconds
                        setTimeout(() => {
                            alertMarker.setMap(null);
                            alertMarkers = alertMarkers.filter(m => m !== alertMarker);
                        }, 10000);
                    }
                });
            }
        }

        function showAlertBanner(message) {
            const banner = document.getElementById('alert-banner');
            banner.textContent = message;
            banner.style.display = 'block';
            
            // Hide after 15 seconds
            setTimeout(() => {
                banner.style.display = 'none';
            }, 15000);
        }

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result">No buildings found</div>';
            } else {
                results.forEach(building => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'search-result';
                    resultElement.textContent = building.title;
                    resultElement.addEventListener('click', () => {
                        const target = new google.maps.LatLng(building.lat, building.lng);
                        centerAndPulse(target, building.title);
                        searchResults.style.display = 'none';
                        document.getElementById('search-input').value = building.title;
                        selectedBuilding = building;
                        showDirectionsPanel();
                    });
                    searchResults.appendChild(resultElement);
                });
            }
            
            searchResults.style.display = 'block';
        }

        function displayRoomResults(results) {
            const roomResults = document.getElementById('room-results');
            roomResults.innerHTML = '';
            
            if (results.length === 0) {
                roomResults.innerHTML = '<div class="search-result">No classes found</div>';
            } else {
                results.forEach(course => {
                    const building = BUILDINGS.find(b => b.id === course.building);
                    if (building) {
                        const resultElement = document.createElement('div');
                        resultElement.className = 'search-result';
                        resultElement.innerHTML = `
                            <strong>${course.code}</strong><br>
                            <small>${course.name}</small><br>
                            <small>${building.title}, Room ${course.room}</small>
                        `;
                        resultElement.addEventListener('click', () => {
                            const target = new google.maps.LatLng(building.lat, building.lng);
                            centerAndPulse(target, `${building.title}, Room ${course.room}`);
                            document.getElementById('room-search').value = course.code;
                            selectedBuilding = building;
                            showDirectionsPanel();
                        });
                        roomResults.appendChild(resultElement);
                    }
                });
            }
        }

        function centerAndPulse(position, title) {
            map.panTo(position);
            map.setZoom(18);
            
            // Pulse animation
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                animation: google.maps.Animation.BOUNCE,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: "#FFD700",
                    fillOpacity: 0.8,
                    strokeColor: "#FFFFFF",
                    strokeWeight: 3,
                    scale: 10,
                    optimized: true
                },
                zIndex: google.maps.Marker.MAX_ZINDEX + 2
            });
            
            setTimeout(() => marker.setMap(null), 1400);
        }

        function showBuildingInfo(building) {
            selectedBuilding = building;
            
            const isOpen = checkIfBuildingIsOpen(building);
            const nextOpen = getNextOpeningTime(building);
            
            // Create info window content
            const content = `
                <div style="max-width:250px">
                    <h3 style="margin:0 0 5px 0;color:#00509E">${building.title}</h3>
                    <p>${building.category} Building</p>
                    ${isOpen ? '<p style="color:green;">● Open Now</p>' : `<p style="color:red;">● Closed - Opens ${nextOpen}</p>`}
                    ${building.accessibility.wheelchair ? '<p>♿ Wheelchair accessible</p>' : ''}
                    ${building.accessibility.elevator ? '<p>🛗 Elevator available</p>' : ''}
                    ${building.hasCoveredAccess ? '<p>☔ Covered access available</p>' : ''}
                    <button onclick="window.showDirectionsFromHere(${building.lat},${building.lng})" 
                            style="background:#00509E;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px">
                        Get Directions
                    </button>
                </div>
            `;
            
            // Create and open info window
            const infoWindow = new google.maps.InfoWindow({
                content: content
            });
            
            infoWindow.open(map, new google.maps.Marker({
                position: { lat: building.lat, lng: building.lng },
                map: map
            }));
        }

        function showSocialSpotInfo(spot) {
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding:10px;max-width:250px">
                        <h3 style="margin:0 0 5px 0;color:#00509E">${spot.title}</h3>
                        <p>${spot.description}</p>
                        <div style="margin-top:5px;margin-bottom:10px;">
                            <span style="color:#34A853">↑${spot.upvotes}</span> 
                            <span style="color:#EA4335">↓${spot.downvotes}</span>
                        </div>
                        <button onclick="navigateToSpot(${spot.lat}, ${spot.lng})" 
                                style="background:#00509E;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px;width:100%">
                            Navigate Here
                        </button>
                        <button onclick="voteOnSpot('${spot.id}', 'up')" 
                                style="background:#34A853;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px;width:48%">
                            Upvote
                        </button>
                        <button onclick="voteOnSpot('${spot.id}', 'down')" 
                                style="background:#EA4335;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px;width:48%;float:right">
                            Downvote
                        </button>
                    </div>
                `,
                maxWidth: 300
            });
            
            const marker = new google.maps.Marker({
                position: { lat: spot.lat, lng: spot.lng },
                map: map
            });
            
            infoWindow.open(map, marker);
            
            // Close the marker after 10 seconds
            setTimeout(() => {
                infoWindow.close();
                marker.setMap(null);
            }, 10000);
        }

        // Make these functions available globally
        window.showDirectionsFromHere = function(lat, lng) {
            if (userLocationMarker) {
                calculateAndDisplayRoute({ lat, lng }, 'WALKING');
            } else {
                alert("Please enable your location first");
            }
        };

        window.navigateToSpot = function(lat, lng) {
            if (userLocationMarker) {
                calculateAndDisplayRoute({ lat, lng }, 'WALKING');
            } else {
                alert("Please enable your location first");
            }
        };

        window.voteOnSpot = function(spotId, voteType) {
            const spot = SOCIAL_POINTS.find(s => s.id === spotId);
            if (spot) {
                if (voteType === 'up') {
                    spot.upvotes++;
                } else {
                    spot.downvotes++;
                }
                alert(`Thanks for your vote! ${voteType === 'up' ? 'Up' : 'Down'}vote recorded.`);
            }
        };

        window.requestMeetup = function(lat, lng, friendName) {
            if (!userLocationMarker) {
                alert('Please enable your location first');
                return;
            }
            
            const meetupPoint = calculateMidpoint(
                userLocationMarker.getPosition(),
                new google.maps.LatLng(lat, lng)
            );
            
            // Clear any existing meetup
            if (meetupMarker) {
                meetupMarker.setMap(null);
            }
            if (meetupTimer) {
                clearInterval(meetupTimer);
            }
            
            // Create meetup marker
            meetupMarker = new google.maps.Marker({
                position: meetupPoint,
                map: map,
                title: 'Meetup Point',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: "#FFD700",
                    fillOpacity: 0.9,
                    strokeColor: "#FFFFFF",
                    strokeWeight: 2,
                    scale: 12,
                },
                zIndex: google.maps.Marker.MAX_ZINDEX + 5,
                animation: google.maps.Animation.BOUNCE
            });
            
            // Add countdown timer
            const countdown = 15; // minutes
            const countdownElement = document.createElement('div');
            countdownElement.id = 'meetup-countdown';
            countdownElement.textContent = `${countdown}:00`;
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding:10px;text-align:center">
                        <h3 style="margin:0">Meetup Point</h3>
                        <p>Suggested midpoint between you and ${friendName}</p>
                        <div id="meetup-countdown">${countdown}:00</div>
                        <button onclick="navigateToMeetup(${meetupPoint.lat()}, ${meetupPoint.lng()})" 
                                style="background:#00509E;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px">
                            Navigate Here
                        </button>
                    </div>
                `
            });
            
            infoWindow.open(map, meetupMarker);
            
            // Start countdown
            let minutes = countdown - 1;
            let seconds = 59;
            meetupTimer = setInterval(() => {
                const countdownText = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
                countdownElement.textContent = countdownText;
                
                if (seconds === 0) {
                    if (minutes === 0) {
                        clearInterval(meetupTimer);
                        infoWindow.setContent('<div style="padding:10px">Meetup time expired</div>');
                        setTimeout(() => {
                            meetupMarker.setMap(null);
                            infoWindow.close();
                            meetupMarker = null;
                        }, 3000);
                        return;
                    }
                    minutes--;
                    seconds = 59;
                } else {
                    seconds--;
                }
            }, 1000);
            
            // Store references to clean up later
            window.currentMeetup = {
                marker: meetupMarker,
                infoWindow: infoWindow,
                timer: meetupTimer
            };
        };

        window.navigateToMeetup = function(lat, lng) {
            if (userLocationMarker) {
                calculateAndDisplayRoute({ lat, lng }, 'WALKING');
            } else {
                alert("Please enable your location first");
            }
        };

        window.findMidpoint = function(friendId) {
            const friend = FRIENDS.find(f => f.id === friendId);
            if (friend && userLocationMarker) {
                const midpoint = calculateMidpoint(
                    userLocationMarker.getPosition(),
                    new google.maps.LatLng(friend.location.lat, friend.location.lng)
                );
                
                requestMeetup(friend.location.lat, friend.location.lng, friend.name);
                
                // Zoom to show both locations and midpoint
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(userLocationMarker.getPosition());
                bounds.extend(new google.maps.LatLng(friend.location.lat, friend.location.lng));
                bounds.extend(midpoint);
                map.fitBounds(bounds);
            }
        };

        function calculateMidpoint(pos1, pos2) {
            return new google.maps.LatLng(
                (pos1.lat() + pos2.lat()) / 2,
                (pos1.lng() + pos2.lng()) / 2
            );
        }

        function showDirectionsPanel() {
            document.getElementById('directions-panel').style.display = 'block';
            document.getElementById('reset-directions').style.display = 'block';
            
            if (userLocationMarker) {
                calculateAndDisplayRoute(selectedBuilding, 'WALKING');
            } else {
                document.getElementById('directions-instructions').innerHTML = 
                    '<p>Enable location services to get directions from your current position.</p>';
            }
        }

        function calculateAndDisplayRoute(destination, mode) {
            if (!userLocationMarker) return;

            // Show loading state
            document.getElementById('route-info-container').style.display = 'none';
            document.getElementById('directions-instructions').innerHTML = '<p>Calculating route...</p>';
            
            const request = {
                origin: userLocationMarker.getPosition(),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode[mode],
                provideRouteAlternatives: false
            };

            // Add accessibility options if enabled
            if (currentScenario === 'accessibility') {
                request.travelOptions = {
                    routingPreference: document.getElementById('wheelchair-route').checked ? 
                        'WHEELCHAIR_ACCESSIBLE' : undefined
                };
                
                // In a real implementation, you would use avoidStairs and preferCovered options here
            }
            
            // Adjust walking speed (simulated)
            const walkingSpeed = document.getElementById('walking-speed').value;
            if (walkingSpeed && mode === 'WALKING') {
                // This would affect the route calculation in a real implementation
                console.log(`Calculating route with ${walkingSpeed} walking speed`);
            }

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    // Clear any existing route
                    if (currentRoutePolyline) {
                        currentRoutePolyline.setMap(null);
                    }
                    
                    // Render the directions
                    directionsRenderer.setDirections(result);
                    
                    // Get the route path for animation
                    const route = result.routes[0];
                    const path = route.overview_path;
                    
                    // Create a new polyline for the animated path
                    currentRoutePolyline = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: '#00509E',
                        strokeOpacity: 1.0,
                        strokeWeight: 5,
                        map: map
                    });
                    
                    // Add the animation class
                    const line = currentRoutePolyline.get('stroke');
                    if (line) {
                        line.classList.add('animate-path');
                    }
                    
                    // Display route information
                    displayRouteInfo(result.routes[0].legs[0]);
                    
                    // Fit the bounds to show the entire route
                    const bounds = new google.maps.LatLngBounds();
                    path.forEach(point => bounds.extend(point));
                    map.fitBounds(bounds);
                    
                    // Suggest covered route if raining
                    if (currentWeather === 'rain' && document.getElementById('prefer-covered').checked) {
                        suggestCoveredRoutes();
                    }
                } else {
                    console.error('Directions request failed:', status);
                    document.getElementById('directions-instructions').innerHTML = 
                        `<p style="color:red;">Could not calculate route: ${status}</p>`;
                }
            });
        }

        function calculateMultiStopRoute() {
            if (!userLocationMarker || routeStops.length < 2) return;
            
            // Show loading state
            document.getElementById('route-info-container').style.display = 'none';
            document.getElementById('directions-instructions').innerHTML = '<p>Calculating multi-stop route...</p>';
            
            // Create waypoints (all stops except first and last)
            const waypoints = routeStops.slice(1, -1).map(stop => ({
                location: stop.position,
                stopover: true
            }));
            
            const request = {
                origin: userLocationMarker.getPosition(),
                destination: routeStops[routeStops.length - 1].position,
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.WALKING,
                optimizeWaypoints: true,
                provideRouteAlternatives: false
            };
            
            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    // Clear any existing route
                    if (currentRoutePolyline) {
                        currentRoutePolyline.setMap(null);
                    }
                    
                    // Render the directions
                    directionsRenderer.setDirections(result);
                    
                    // Get the route path for animation
                    const route = result.routes[0];
                    const path = route.overview_path;
                    
                    // Create a new polyline for the animated path
                    currentRoutePolyline = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: '#00509E',
                        strokeOpacity: 1.0,
                        strokeWeight: 5,
                        map: map
                    });
                    
                    // Add the animation class
                    const line = currentRoutePolyline.get('stroke');
                    if (line) {
                        line.classList.add('animate-path');
                    }
                    
                    // Display route information
                    displayRouteInfo(result.routes[0].legs[0]);
                    
                    // Fit the bounds to show the entire route
                    const bounds = new google.maps.LatLngBounds();
                    path.forEach(point => bounds.extend(point));
                    map.fitBounds(bounds);
                    
                    // Add stop markers
                    routeStops.forEach((stop, index) => {
                        new google.maps.Marker({
                            position: stop.position,
                            map: map,
                            label: {
                                text: (index + 1).toString(),
                                color: 'white',
                                fontSize: '12px'
                            },
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: "#EA4335",
                                fillOpacity: 0.9,
                                strokeColor: "#FFFFFF",
                                strokeWeight: 2,
                                scale: 8
                            },
                            zIndex: google.maps.Marker.MAX_ZINDEX + 3
                        });
                    });
                } else {
                    console.error('Directions request failed:', status);
                    document.getElementById('directions-instructions').innerHTML = 
                        `<p style="color:red;">Could not calculate route: ${status}</p>`;
                }
            });
        }

        function updateStopsList() {
            const stopsList = document.getElementById('stops-list');
            stopsList.innerHTML = '';
            
            routeStops.forEach((stop, index) => {
                const stopElement = document.createElement('div');
                stopElement.style.padding = '5px';
                stopElement.style.borderBottom = '1px solid #eee';
                stopElement.style.display = 'flex';
                stopElement.style.justifyContent = 'space-between';
                stopElement.style.alignItems = 'center';
                
                stopElement.innerHTML = `
                    <span>${index + 1}. ${stop.title}</span>
                    <button class="remove-stop" data-index="${index}" style="background:#EA4335;color:white;border:none;border-radius:3px;padding:2px 5px;cursor:pointer">
                        ×
                    </button>
                `;
                
                stopsList.appendChild(stopElement);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-stop').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    routeStops.splice(index, 1);
                    updateStopsList();
                    
                    if (routeStops.length === 0) {
                        document.getElementById('multi-stop-container').style.display = 'none';
                        resetDirections();
                    }
                });
            });
        }

        function suggestCoveredRoutes() {
            // In a real implementation, this would analyze the route for covered sections
            // and suggest alternatives if needed
            
            const hasCoveredRoute = BUILDINGS.some(b => 
                b.hasCoveredAccess && 
                isPointNearRoute(new google.maps.LatLng(b.lat, b.lng))
            );
            
            if (!hasCoveredRoute) {
                const coveredBuildings = BUILDINGS.filter(b => b.hasCoveredAccess);
                if (coveredBuildings.length > 0) {
                    const suggestion = document.createElement('div');
                    suggestion.innerHTML = `
                        <p style="color:#00509E;margin-top:10px;">
                            <strong>Weather Alert:</strong> It's raining! Consider taking a covered route via 
                            ${coveredBuildings[0].title}.
                        </p>
                        <button onclick="takeCoveredRoute(${coveredBuildings[0].lat}, ${coveredBuildings[0].lng})" 
                                style="background:#00509E;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px">
                            Show Covered Route
                        </button>
                    `;
                    
                    document.getElementById('directions-instructions').appendChild(suggestion);
                }
            }
        }

        window.takeCoveredRoute = function(lat, lng) {
            if (!userLocationMarker || !selectedBuilding) return;
            
            // Add the covered building as a waypoint
            routeStops = [
                {
                    position: new google.maps.LatLng(lat, lng),
                    title: 'Covered Route Point'
                },
                {
                    position: new google.maps.LatLng(selectedBuilding.lat, selectedBuilding.lng),
                    title: selectedBuilding.title
                }
            ];
            
            updateStopsList();
            document.getElementById('multi-stop-container').style.display = 'block';
            calculateMultiStopRoute();
        };

        function isPointNearRoute(point) {
            // In a real implementation, this would check if the point is near the current route
            return false;
        }

        function displayRouteInfo(routeLeg) {
            const routeInfoContainer = document.getElementById('route-info-container');
            const routeDuration = document.getElementById('route-duration');
            const routeLength = document.getElementById('route-length');
            const routeSteps = document.getElementById('route-steps');
            
            // Update duration and distance
            routeDuration.textContent = routeLeg.duration.text;
            routeLength.textContent = routeLeg.distance.text;
            
            // Clear previous steps
            routeSteps.innerHTML = '';
            
            // Add each step to the route info
            routeLeg.steps.forEach(step => {
                const stepElement = document.createElement('div');
                stepElement.className = 'route-step';
                
                // Get appropriate icon for the step
                let icon = '➡️'; // Default arrow
                if (step.instructions.includes('left')) icon = '⬅️';
                if (step.instructions.includes('right')) icon = '➡️';
                if (step.instructions.includes('straight')) icon = '⬆️';
                if (step.instructions.includes('destination')) icon = '🏁';
                
                stepElement.innerHTML = `
                    <div class="step-icon">${icon}</div>
                    <div class="step-text">
                        ${step.instructions.replace(/<div[^>]*>/g, '').replace(/<\/div>/g, '')}
                        <div class="step-distance">${step.distance.text} • ${step.duration.text}</div>
                    </div>
                `;
                
                routeSteps.appendChild(stepElement);
            });
            
            // Show the route info panel
            routeInfoContainer.style.display = 'block';
        }

        function resetDirections() {
            directionsRenderer.setMap(null);
            document.getElementById('directions-panel').style.display = 'none';
            document.getElementById('reset-directions').style.display = 'none';
            document.getElementById('route-info-container').style.display = 'none';
            document.getElementById('multi-stop-container').style.display = 'none';
            
            if (currentRoutePolyline) {
                currentRoutePolyline.setMap(null);
                currentRoutePolyline = null;
            }
            
            selectedBuilding = null;
            routeStops = [];
        }

        function resetMap() {
            const bounds = new google.maps.LatLngBounds();
            BOUNDARY_COORDS.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds);
            resetDirections();
        }

        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            debugElement.textContent = message;
            debugElement.style.display = 'block';
            setTimeout(() => {
                debugElement.style.display = 'none';
            }, 5000);
        }

        // Enhanced location tracking functions
        function getUserLocation(centerOnUser) {
            if (!navigator.geolocation) {
                updateDebugInfo("Geolocation not supported by this browser");
                return;
            }
            
            // Clear any existing watcher
            if (watchPositionId !== null) {
                navigator.geolocation.clearWatch(watchPositionId);
            }
            
            // First try to get position quickly
            navigator.geolocation.getCurrentPosition(
                (position) => handlePositionSuccess(position, centerOnUser),
                (error) => handlePositionError(error),
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
            
            // Then set up continuous tracking
            watchPositionId = navigator.geolocation.watchPosition(
                (position) => handlePositionSuccess(position, true),
                (error) => handlePositionError(error),
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 5000
                }
            );
        }
        
        function handlePositionSuccess(position, centerOnUser) {
            const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            console.log("Got position:", pos, "with accuracy:", position.coords.accuracy, "meters");
            
            // Create or update user location marker
            if (!userLocationMarker) {
                userLocationMarker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: "Your Location",
                    icon: {
                        url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(
                            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="8" fill="#4285F4" stroke="white" stroke-width="2"/>
                            </svg>`
                        ),
                        scaledSize: new google.maps.Size(24, 24),
                        anchor: new google.maps.Point(12, 12)
                    },
                    zIndex: google.maps.Marker.MAX_ZINDEX + 100
                });
            } else {
                userLocationMarker.setPosition(pos);
            }
            
            // Update accuracy circle
            if (accuracyCircle) {
                accuracyCircle.setMap(null);
            }
            
            accuracyCircle = new google.maps.Circle({
                strokeColor: "#4285F4",
                strokeOpacity: 0.4,
                strokeWeight: 1,
                fillColor: "#4285F4",
                fillOpacity: 0.2,
                map: map,
                center: pos,
                radius: position.coords.accuracy
            });
            
            // Center map if requested
            if (centerOnUser) {
                map.panTo(pos);
                map.setZoom(18);
            }
            
            // If we have a selected building, update route
            if (selectedBuilding) {
                calculateAndDisplayRoute(selectedBuilding, 'WALKING');
            }
            
            // Check if we're near any class locations
            checkProximityToClasses();
        }
        
        function handlePositionError(error) {
            console.error("Geolocation error:", error);
            let errorMessage = "Location error: ";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += "Location permission denied. Please enable location access in your browser settings.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += "Location unavailable. Please check your network/GPS connection.";
                    break;
                case error.TIMEOUT:
                    errorMessage += "Location request timed out. Trying again...";
                    // Retry with less accuracy
                    navigator.geolocation.getCurrentPosition(
                        (position) => handlePositionSuccess(position, true),
                        (error) => handlePositionError(error),
                        {
                            enableHighAccuracy: false,
                            timeout: 10000,
                            maximumAge: 30000
                        }
                    );
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage += "Unknown error occurred.";
                    break;
            }
            updateDebugInfo(errorMessage);
        }

        function checkIfBuildingIsOpen(building) {
            if (!building.hours) return true;
            
            const now = new Date();
            const day = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const hours = now.getHours();
            
            // Check for exceptions (holidays, etc.)
            if (building.hours.exceptions) {
                const todayStr = now.toISOString().split('T')[0];
                const exception = building.hours.exceptions.find(e => e.date === todayStr);
                if (exception) {
                    return exception.isOpen;
                }
            }
            
            // Check weekday/weekend hours
            if (day >= 1 && day <= 5) { // Weekday
                if (building.hours.weekdays) {
                    return hours >= building.hours.weekdays.open && 
                           hours < building.hours.weekdays.close;
                }
            } else { // Weekend
                if (building.hours.weekends) {
                    return hours >= building.hours.weekends.open && 
                           hours < building.hours.weekends.close;
                }
            }
            
            return true; // Default to open if no hours specified
        }

        function getNextOpeningTime(building) {
            if (!building.hours) return "now";
            
            const now = new Date();
            const day = now.getDay();
            const hours = now.getHours();
            
            // Check if currently open
            if (checkIfBuildingIsOpen(building)) {
                return "now";
            }
            
            // Find next opening time
            if (day >= 1 && day <= 5) { // Weekday
                if (building.hours.weekdays) {
                    if (hours < building.hours.weekdays.open) {
                        return `at ${building.hours.weekdays.open}:00`;
                    } else {
                        return "tomorrow";
                    }
                }
            } else { // Weekend
                if (building.hours.weekends) {
                    if (hours < building.hours.weekends.open) {
                        return `at ${building.hours.weekends.open}:00`;
                    } else {
                        return "tomorrow";
                    }
                }
            }
            
            return "soon";
        }

        function updateBuildingStatus() {
            BUILDINGS.forEach(building => {
                const isOpen = checkIfBuildingIsOpen(building);
                const markers = map.markers || []; // In a real app, you'd track your markers
                
                // Find and update the marker for this building
                markers.forEach(marker => {
                    if (marker.get('id') === building.id) {
                        marker.setIcon({
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: isOpen ? building.color : "#CCCCCC",
                            fillOpacity: 0.9,
                            strokeColor: "#FFFFFF",
                            strokeWeight: 2,
                            scale: 8
                        });
                        
                        if (isOpen) {
                            marker.set('class', '');
                        } else {
                            marker.set('class', 'closed-building');
                        }
                    }
                });
            });
        }

        function checkUpcomingClasses() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentDay = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][now.getDay()];
            
            CLASS_SCHEDULE.forEach(course => {
                if (course.days.includes(currentDay)) {
                    const [startHour, startMinute] = course.time.start.split(':').map(Number);
                    const [endHour, endMinute] = course.time.end.split(':').map(Number);
                    
                    // Check if class starts within the next 15 minutes
                    if ((startHour === currentHour && startMinute > currentMinute && startMinute <= currentMinute + 15) ||
                        (startHour === currentHour + 1 && startMinute <= 15 && currentMinute >= 45)) {
                        
                        const building = BUILDINGS.find(b => b.id === course.building);
                        if (building) {
                            showClassNotification(course, building);
                        }
                    }
                }
            });
        }

        function showClassNotification(course, building) {
            const notification = document.createElement('div');
            notification.style.position = 'absolute';
            notification.style.top = '100px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#00509E';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '1000';
            notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            notification.style.animation = 'fadeInUp 0.3s ease-out';
            
            notification.innerHTML = `
                <h3 style="margin:0 0 5px 0;">Class Starting Soon</h3>
                <p style="margin:0 0 10px 0;">
                    ${course.code} at ${building.title}, Room ${course.room}<br>
                    Starts at ${course.time.start}
                </p>
                <button onclick="navigateToClass('${course.building}', '${course.room}')" 
                        style="background:white;color:#00509E;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-right:5px;">
                    Get Directions
                </button>
                <button onclick="this.parentNode.remove()" 
                        style="background:transparent;color:white;border:1px solid white;padding:5px 10px;border-radius:3px;cursor:pointer;">
                    Dismiss
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-dismiss after 1 minute
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 60000);
        }

        window.navigateToClass = function(buildingId, room) {
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (building) {
                const target = new google.maps.LatLng(building.lat, building.lng);
                centerAndPulse(target, `${building.title}, Room ${room}`);
                selectedBuilding = building;
                showDirectionsPanel();
            }
        };

        function checkProximityToClasses() {
            if (!userLocationMarker) return;
            
            const userPos = userLocationMarker.getPosition();
            const now = new Date();
            const currentDay = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][now.getDay()];
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            CLASS_SCHEDULE.forEach(course => {
                if (course.days.includes(currentDay)) {
                    const [startHour, startMinute] = course.time.start.split(':').map(Number);
                    const [endHour, endMinute] = course.time.end.split(':').map(Number);
                    
                    // Check if class is currently in session
                    if ((currentHour > startHour || (currentHour === startHour && currentMinute >= startMinute)) &&
                        (currentHour < endHour || (currentHour === endHour && currentMinute <= endMinute))) {
                        
                        const building = BUILDINGS.find(b => b.id === course.building);
                        if (building) {
                            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                                userPos,
                                new google.maps.LatLng(building.lat, building.lng)
                            );
                            
                            // If more than 200m away during class time
                            if (distance > 200) {
                                showClassReminder(course, building);
                            }
                        }
                    }
                }
            });
        }

        function showClassReminder(course, building) {
            // Check if reminder already shown
            if (localStorage.getItem(`reminder-${course.code}-${new Date().toDateString()}`)) {
                return;
            }
            
            const reminder = document.createElement('div');
            reminder.style.position = 'absolute';
            reminder.style.bottom = '100px';
            reminder.style.left = '50%';
            reminder.style.transform = 'translateX(-50%)';
            reminder.style.backgroundColor = '#E74C3C';
            reminder.style.color = 'white';
            reminder.style.padding = '10px 20px';
            reminder.style.borderRadius = '5px';
            reminder.style.zIndex = '1000';
            reminder.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            reminder.style.animation = 'fadeInUp 0.3s ease-out';
            reminder.style.maxWidth = '80%';
            reminder.style.textAlign = 'center';
            
            reminder.innerHTML = `
                <h3 style="margin:0 0 5px 0;">Class in Session</h3>
                <p style="margin:0 0 10px 0;">
                    ${course.code} is currently in session at ${building.title}, Room ${course.room}<br>
                    ${course.time.start} - ${course.time.end}
                </p>
                <button onclick="navigateToClass('${course.building}', '${course.room}')" 
                        style="background:white;color:#E74C3C;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-right:5px;">
                    Get Directions
                </button>
                <button onclick="this.parentNode.remove();localStorage.setItem('reminder-${course.code}-${new Date().toDateString()}', 'dismissed')" 
                        style="background:transparent;color:white;border:1px solid white;padding:5px 10px;border-radius:3px;cursor:pointer;">
                    Dismiss
                </button>
            `;
            
            document.body.appendChild(reminder);
            
            // Auto-dismiss after 5 minutes
            setTimeout(() => {
                if (reminder.parentNode) {
                    reminder.remove();
                }
            }, 300000);
        }

        function checkClassTime(classText) {
            // Extract time from class text (e.g. "10:00-11:00")
            const timeMatch = classText.match(/\d{1,2}:\d{2}-\d{1,2}:\d{2}/);
            if (!timeMatch) return;
            
            const [startTime, endTime] = timeMatch[0].split('-');
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Check if class starts within the next 15 minutes
            if ((startHour === currentHour && startMinute > currentMinute && startMinute <= currentMinute + 15) ||
                (startHour === currentHour + 1 && startMinute <= 15 && currentMinute >= 45)) {
                
                const notification = document.createElement('div');
                notification.style.position = 'absolute';
                notification.style.top = '100px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.backgroundColor = '#00509E';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '5px';
                notification.style.zIndex = '1000';
                notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                notification.style.animation = 'fadeInUp 0.3s ease-out';
                
                notification.innerHTML = `
                    <h3 style="margin:0 0 5px 0;">Class Starts Soon</h3>
                    <p style="margin:0 0 10px 0;">${classText}</p>
                    <button onclick="this.parentNode.remove()" 
                            style="background:white;color:#00509E;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;">
                        Dismiss
                    </button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-dismiss after 1 minute
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 60000);
            }
        }

        function getBuildingAtLocation(location) {
            return BUILDINGS.find(b => 
                Math.abs(b.lat - location.lat) < 0.0005 && 
                Math.abs(b.lng - location.lng) < 0.0005
            );
        }
    </script>
    <script>
        // Load Google Maps API with proper async pattern
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyA0eo_kH5S8DCX53vLaILohfuo0-nkwqQc&libraries=places,geometry&callback=initMap';
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                document.getElementById('map').innerHTML = 
                    '<div style="padding:20px;color:red">Failed to load Google Maps. Please check your internet connection.</div>';
            };
            document.head.appendChild(script);
        }
        
        // Start loading the map when page loads
        window.onload = loadGoogleMaps;
    </script>
</body>
</html>
