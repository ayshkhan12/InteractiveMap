<!DOCTYPE html>
<html>
<head>
    <title>Interactive University of Hull Map</title>
    <style>
        /* Main map container */
        #map {
            height: 100vh;
            width: 100%;
            transition: margin-left 0.3s ease;
        }
        
        /* Navigation panel - moved to left */
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 5;
            background: rgba(255,255,255,0.98);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            width: 280px;
            font-family: Arial, sans-serif;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        /* Hamburger menu */
        #menu-toggle {
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 10;
            background: #00509E;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px;
            cursor: pointer;
            display: none;
        }
        
        /* Scenario panels */
        .scenario-panel {
            display: none;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        /* Accessibility markers */
        .accessibility-marker {
            background-color: #2ECC71;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        /* Emergency markers */
        .emergency-marker {
            background-color: #E74C3C;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* Alert banner */
        #alert-banner {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,204,0,0.9);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10;
            display: none;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Keep all your existing styles */
        #search-container {
            margin-bottom: 15px;
        }
        #search-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            display: none;
        }
        #directions-panel {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            display: none;
        }
        .category {
            color: #00509E;
            font-weight: bold;
            margin: 15px 0 5px 0;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        button:hover {
            background: #00509E;
            color: white;
        }
        #logo {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #00509E;
            font-size: 1.1em;
        }
        #recenter-btn, #reset-directions, #show-location, #toggle-satellite {
            background: #00509E;
            color: white;
            text-align: center;
        }
        .search-result {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-result:hover {
            background: #f0f7ff;
        }
        .mode-selector {
            margin: 10px 0;
        }
        .mode-btn {
            display: inline-block;
            width: auto;
            padding: 5px 10px;
            margin-right: 5px;
        }
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            display: none;
        }
        .building-label {
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 3px #000;
            padding: 2px 5px;
            background-color: rgba(0, 80, 158, 0.7);
            border-radius: 3px;
        }
        .mode-toggle {
            background: #00509E;
            color: white;
            text-align: center;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- Hamburger menu -->
    <button id="menu-toggle">☰</button>
    
    <!-- Navigation Panel (now on left) -->
    <div id="controls">
        <div id="logo">UNIVERSITY OF HULL</div>
        
        <!-- Search Box -->
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search buildings...">
            <div id="search-results"></div>
        </div>
        
        <button id="recenter-btn">Reset View</button>
        <button id="show-location">Show My Location</button>
        <button id="toggle-satellite">Toggle Satellite View</button>
        <button id="reset-directions" style="display:none;">Clear Directions</button>
        
        <!-- Directions Panel -->
        <div id="directions-panel">
            <div class="mode-selector">
                <button class="mode-btn" data-mode="WALKING">Walk</button>
                <button class="mode-btn" data-mode="DRIVING">Drive</button>
            </div>
            <div id="directions-instructions"></div>
            <div id="distance-info"></div>
        </div>
        
        <!-- Scenario Selection -->
        <div class="category">MAP SCENARIOS</div>
        <button id="scenario-student" class="mode-toggle">Student Mode</button>
        <button id="scenario-accessibility" class="mode-toggle">Accessibility</button>
        <button id="scenario-emergency" class="mode-toggle">Emergency</button>
        
        <!-- Student Scenario Panel -->
        <div id="student-panel" class="scenario-panel">
            <input type="text" id="room-search" placeholder="Enter course code (e.g. CS101)">
            <div id="room-results"></div>
        </div>
        
        <!-- Accessibility Scenario Panel -->
        <div id="accessibility-panel" class="scenario-panel">
            <label>
                <input type="checkbox" id="wheelchair-route" checked> 
                Wheelchair accessible routes only
            </label>
            <label>
                <input type="checkbox" id="avoid-stairs" checked> 
                Avoid stairs
            </label>
        </div>
        
        <!-- Emergency Scenario Panel -->
        <div id="emergency-panel" class="scenario-panel">
            <button id="find-security">Find Security Office</button>
            <button id="find-medical">Find Medical Help</button>
            <button id="emergency-call">Call Campus Security</button>
        </div>
        
        <!-- Building Categories -->
        <div class="category">ACADEMIC BUILDINGS</div>
        <button class="goto-btn" data-lat="53.771112" data-lng="-0.369320">Brynmor Jones Library</button>
        <button class="goto-btn" data-lat="53.770998" data-lng="-0.370300">Allam Medical Building</button>
        <button class="goto-btn" data-lat="53.770821" data-lng="-0.366477">Wilberforce Building</button>
        <button class="goto-btn" data-lat="53.770330" data-lng="-0.368166">Larkin Building</button>
        <button class="goto-btn" data-lat="53.771509" data-lng="-0.368860">Robert Blackburn</button>
        
        <div class="category">STUDENT LIFE</div>
        <button class="goto-btn" data-lat="53.772666" data-lng="-0.365194">Masjid Hull University</button>
        <button class="goto-btn" data-lat="53.771961" data-lng="-0.366254">Student Union (Asylum)</button>
        <button class="goto-btn" data-lat="53.771715" data-lng="-0.366143">Wetherspoons (Sanctuary)</button>
        
        <div class="category">ACCOMMODATIONS</div>
        <button class="goto-btn" data-lat="53.772658" data-lng="-0.366401">The Courtyard</button>
        <button class="goto-btn" data-lat="53.771534" data-lng="-0.372415">Westfield Court</button>
        <button class="goto-btn" data-lat="53.770757" data-lng="-0.364416">Taylor Court</button>
        
        <div class="category">SPORTS</div>
        <button class="goto-btn" data-lat="53.774024" data-lng="-0.368526">Allam Sports Centre</button>
    </div>

    <div id="map"></div>
    <div id="alert-banner"></div>
    <div id="debug-info"></div>

    <script>
        // Boundary coordinates (invisible crop)
        const BOUNDARY_COORDS = [
            { lat: 53.776447, lng: -0.371282 }, // NW
            { lat: 53.772511, lng: -0.374911 }, // NE
            { lat: 53.769470, lng: -0.371443 }, // SE
            { lat: 53.769553, lng: -0.366529 }, // SW
            { lat: 53.770662, lng: -0.362849 }, // Additional
            { lat: 53.776204, lng: -0.365295 }  // Additional
        ];

        // Global variables
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocationMarker;
        let selectedBuilding = null;
        let isSatelliteView = false;
        let panelState = localStorage.getItem('panelState') !== 'closed';
        let currentScenario = null;
        let alertMarkers = [];
        let accessibilityMarkers = [];
        let emergencyMarkers = [];

        // Enhanced buildings data with rooms
        const BUILDINGS = [
            {
                id: "LIB-01",
                title: "Brynmor Jones Library",
                lat: 53.771112,
                lng: -0.369320,
                color: "#00509E",
                category: "Academic",
                rooms: ["LB101", "LB202", "LB305"],
                accessibility: {
                    wheelchair: true,
                    elevator: true
                }
            },
            {
                id: "MED-01",
                title: "Allam Medical Building",
                lat: 53.770998,
                lng: -0.370300,
                color: "#00509E",
                category: "Academic",
                rooms: ["AM101", "AM201"],
                accessibility: {
                    wheelchair: true,
                    elevator: true
                }
            },
            {
                id: "WIL-01",
                title: "Wilberforce Building",
                lat: 53.770821,
                lng: -0.366477,
                color: "#00509E",
                category: "Academic",
                rooms: ["WB101", "WB201", "WB301"],
                accessibility: {
                    wheelchair: true,
                    elevator: false
                }
            },
            // Add all other buildings with similar structure
        ];

        // Emergency facilities
        const EMERGENCY_FACILITIES = [
            {
                id: "SEC-01",
                title: "Security Office",
                lat: 53.771500,
                lng: -0.368500,
                type: "security"
            },
            {
                id: "FIR-01",
                title: "First Aid Station",
                lat: 53.770998,
                lng: -0.370300,
                type: "medical"
            }
        ];

        // Class schedule data (example)
        const CLASS_SCHEDULE = [
            {
                code: "CS101",
                building: "WIL-01",
                room: "WB101",
                name: "Introduction to Computer Science"
            },
            {
                code: "BIO201",
                building: "LAR-01",
                room: "LK203",
                name: "Biology Fundamentals"
            }
        ];

        // Teacher alerts
        const TEACHER_ALERTS = [
            {
                id: "ALERT-001",
                buildingId: "WIL-01",
                room: "WB101",
                message: "CS101 moved to Larkin Building Room LK205 today",
                expires: new Date(Date.now() + 86400000).toISOString() // 24 hours from now
            }
        ];

        // Initialize map
        function initMap() {
            // Initialize map with strict boundaries
            const bounds = new google.maps.LatLngBounds();
            BOUNDARY_COORDS.forEach(coord => bounds.extend(coord));

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 53.771, lng: -0.368 },
                zoom: 17,
                mapTypeId: 'hybrid',
                disableDefaultUI: true,
                gestureHandling: "greedy",
                restriction: {
                    latLngBounds: bounds,
                    strictBounds: true
                }
            });

            // Add invisible cropping polygon
            new google.maps.Polygon({
                paths: BOUNDARY_COORDS,
                strokeOpacity: 0,
                fillOpacity: 0,
                map: map
            });

            // Initialize directions services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                preserveViewport: false,
                polylineOptions: {
                    strokeColor: "#00509E",
                    strokeOpacity: 0.8,
                    strokeWeight: 5
                },
                markerOptions: {
                    icon: {
                        url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                    }
                }
            });

            // Add building markers
            BUILDINGS.forEach(building => {
                const marker = new google.maps.Marker({
                    position: { lat: building.lat, lng: building.lng },
                    map: map,
                    title: building.title,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: building.color,
                        fillOpacity: 0.9,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2,
                        scale: 8,
                        optimized: true
                    },
                    zIndex: google.maps.Marker.MAX_ZINDEX + 1
                });

                // Add building labels
                const label = new google.maps.InfoWindow({
                    content: `<div class="building-label">${building.title}</div>`,
                    disableAutoPan: true
                });
                
                marker.addListener("mouseover", () => {
                    label.open(map, marker);
                });
                
                marker.addListener("mouseout", () => {
                    label.close();
                });

                marker.addListener("click", () => {
                    showBuildingInfo(building);
                });
            });

            // Setup UI components
            setupHamburgerMenu();
            setupEventListeners();
            setupScenarios();
            checkTeacherAlerts();

            // Initial location attempt
            getUserLocation(false);
        }

        function setupHamburgerMenu() {
            const toggle = document.getElementById('menu-toggle');
            const panel = document.getElementById('controls');
            
            // Set initial state
            panel.style.transform = panelState ? 'translateX(0)' : 'translateX(-300px)';
            toggle.style.display = 'block';
            
            toggle.addEventListener('click', () => {
                panelState = !panelState;
                localStorage.setItem('panelState', panelState ? 'open' : 'closed');
                panel.style.transform = panelState ? 'translateX(0)' : 'translateX(-300px)';
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    panel.style.transform = 'translateX(0)';
                    toggle.style.display = 'none';
                } else {
                    toggle.style.display = 'block';
                    panel.style.transform = panelState ? 'translateX(0)' : 'translateX(-300px)';
                }
            });
        }

        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.goto-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    const destination = { lat, lng };
                    centerAndPulse(destination, this.textContent);
                });
            });

            // Recenter button
            document.getElementById("recenter-btn").addEventListener("click", resetMap);

            // Show location button
            document.getElementById("show-location").addEventListener("click", () => {
                if (userLocationMarker) {
                    map.panTo(userLocationMarker.getPosition());
                    map.setZoom(18);
                } else {
                    getUserLocation(true);
                }
            });

            // Toggle satellite view
            document.getElementById("toggle-satellite").addEventListener("click", () => {
                isSatelliteView = !isSatelliteView;
                map.setMapTypeId(isSatelliteView ? 'hybrid' : 'roadmap');
                document.getElementById("toggle-satellite").textContent = 
                    isSatelliteView ? "Show Map View" : "Show Satellite View";
            });

            // Reset directions
            document.getElementById("reset-directions").addEventListener("click", resetDirections);

            // Mode selector buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (selectedBuilding) {
                        calculateAndDisplayRoute(selectedBuilding, this.dataset.mode);
                    }
                });
            });

            // Search functionality
            document.getElementById('search-input').addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    document.getElementById('search-results').style.display = 'none';
                    return;
                }
                
                const results = BUILDINGS.filter(building => 
                    building.title.toLowerCase().includes(query)
                );
                
                displaySearchResults(results);
            });
        }

        function setupScenarios() {
            // Student scenario
            document.getElementById('scenario-student').addEventListener('click', () => {
                toggleScenario('student');
            });
            
            // Accessibility scenario
            document.getElementById('scenario-accessibility').addEventListener('click', () => {
                toggleScenario('accessibility');
                updateAccessibilityMarkers();
            });
            
            // Emergency scenario
            document.getElementById('scenario-emergency').addEventListener('click', () => {
                toggleScenario('emergency');
                updateEmergencyMarkers();
            });
            
            // Room search functionality
            document.getElementById('room-search').addEventListener('input', function() {
                const query = this.value.toUpperCase();
                if (query.length < 2) {
                    document.getElementById('room-results').innerHTML = '';
                    return;
                }
                
                const results = CLASS_SCHEDULE.filter(course => 
                    course.code.includes(query) || 
                    course.room.includes(query)
                );
                
                displayRoomResults(results);
            });
            
            // Find security
            document.getElementById('find-security').addEventListener('click', () => {
                const security = EMERGENCY_FACILITIES.find(f => f.type === 'security');
                if (security) {
                    centerAndPulse({ lat: security.lat, lng: security.lng }, security.title);
                    if (userLocationMarker) {
                        calculateAndDisplayRoute(security, 'WALKING');
                    }
                }
            });
            
            // Find medical
            document.getElementById('find-medical').addEventListener('click', () => {
                const medical = EMERGENCY_FACILITIES.find(f => f.type === 'medical');
                if (medical) {
                    centerAndPulse({ lat: medical.lat, lng: medical.lng }, medical.title);
                    if (userLocationMarker) {
                        calculateAndDisplayRoute(medical, 'WALKING');
                    }
                }
            });
            
            // Emergency call
            document.getElementById('emergency-call').addEventListener('click', () => {
                alert("Calling campus security...\n\nIn a real implementation, this would connect to security services.");
            });
            
            // Accessibility options
            document.getElementById('wheelchair-route').addEventListener('change', updateAccessibilityOptions);
            document.getElementById('avoid-stairs').addEventListener('change', updateAccessibilityOptions);
        }

        function toggleScenario(scenario) {
            // Hide all panels first
            document.querySelectorAll('.scenario-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Reset button colors
            document.querySelectorAll('.mode-toggle').forEach(btn => {
                btn.style.backgroundColor = '#00509E';
            });
            
            // If clicking the same scenario, toggle it off
            if (currentScenario === scenario) {
                currentScenario = null;
                return;
            }
            
            // Show selected panel
            currentScenario = scenario;
            const panel = document.getElementById(`${scenario}-panel`);
            panel.style.display = 'block';
            document.getElementById(`scenario-${scenario}`).style.backgroundColor = '#003366';
            
            // Scenario-specific initializations
            switch(scenario) {
                case 'student':
                    document.getElementById('room-search').focus();
                    break;
                case 'accessibility':
                    updateAccessibilityMarkers();
                    break;
                case 'emergency':
                    updateEmergencyMarkers();
                    break;
            }
        }

        function updateAccessibilityMarkers() {
            // Clear existing markers
            accessibilityMarkers.forEach(marker => marker.setMap(null));
            accessibilityMarkers = [];
            
            // Add markers for accessible features
            BUILDINGS.forEach(building => {
                if (building.accessibility.wheelchair) {
                    const content = document.createElement('div');
                    content.className = 'accessibility-marker';
                    content.textContent = '♿ Accessible';
                    
                    const marker = new google.maps.InfoWindow({
                        content: content,
                        position: { lat: building.lat, lng: building.lng },
                        disableAutoPan: true
                    });
                    
                    marker.open(map);
                    accessibilityMarkers.push(marker);
                }
            });
        }

        function updateEmergencyMarkers() {
            // Clear existing markers
            emergencyMarkers.forEach(marker => marker.setMap(null));
            emergencyMarkers = [];
            
            // Add markers for emergency facilities
            EMERGENCY_FACILITIES.forEach(facility => {
                const content = document.createElement('div');
                content.className = 'emergency-marker';
                content.textContent = facility.type === 'security' ? '🚨 Security' : '🏥 Medical';
                
                const marker = new google.maps.InfoWindow({
                    content: content,
                    position: { lat: facility.lat, lng: facility.lng },
                    disableAutoPan: true
                });
                
                marker.open(map);
                emergencyMarkers.push(marker);
            });
        }

        function updateAccessibilityOptions() {
            const wheelchairOnly = document.getElementById('wheelchair-route').checked;
            const avoidStairs = document.getElementById('avoid-stairs').checked;
            
            // In a real implementation, you would use these options to modify directions
            console.log(`Accessibility options updated: wheelchair=${wheelchairOnly}, avoidStairs=${avoidStairs}`);
        }

        function checkTeacherAlerts() {
            const now = new Date();
            const activeAlerts = TEACHER_ALERTS.filter(alert => new Date(alert.expires) > now);
            
            if (activeAlerts.length > 0) {
                showAlertBanner(activeAlerts[0].message);
                
                // Highlight affected buildings
                activeAlerts.forEach(alert => {
                    const building = BUILDINGS.find(b => b.id === alert.buildingId);
                    if (building) {
                        // Add pulsing alert marker
                        const alertMarker = new google.maps.Marker({
                            position: { lat: building.lat, lng: building.lng },
                            map: map,
                            title: "Class Change Alert",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: "#FFA500",
                                fillOpacity: 0.8,
                                strokeColor: "#FFFFFF",
                                strokeWeight: 2,
                                scale: 10
                            },
                            zIndex: google.maps.Marker.MAX_ZINDEX + 4,
                            animation: google.maps.Animation.BOUNCE
                        });
                        
                        alertMarkers.push(alertMarker);
                        
                        // Remove after 10 seconds
                        setTimeout(() => {
                            alertMarker.setMap(null);
                            alertMarkers = alertMarkers.filter(m => m !== alertMarker);
                        }, 10000);
                    }
                });
            }
        }

        function showAlertBanner(message) {
            const banner = document.getElementById('alert-banner');
            banner.textContent = message;
            banner.style.display = 'block';
            
            // Hide after 15 seconds
            setTimeout(() => {
                banner.style.display = 'none';
            }, 15000);
        }

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result">No buildings found</div>';
            } else {
                results.forEach(building => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'search-result';
                    resultElement.textContent = building.title;
                    resultElement.addEventListener('click', () => {
                        const target = new google.maps.LatLng(building.lat, building.lng);
                        centerAndPulse(target, building.title);
                        searchResults.style.display = 'none';
                        document.getElementById('search-input').value = building.title;
                        selectedBuilding = building;
                        showDirectionsPanel();
                    });
                    searchResults.appendChild(resultElement);
                });
            }
            
            searchResults.style.display = 'block';
        }

        function displayRoomResults(results) {
            const roomResults = document.getElementById('room-results');
            roomResults.innerHTML = '';
            
            if (results.length === 0) {
                roomResults.innerHTML = '<div class="search-result">No classes found</div>';
            } else {
                results.forEach(course => {
                    const building = BUILDINGS.find(b => b.id === course.building);
                    if (building) {
                        const resultElement = document.createElement('div');
                        resultElement.className = 'search-result';
                        resultElement.innerHTML = `
                            <strong>${course.code}</strong><br>
                            <small>${course.name}</small><br>
                            <small>${building.title}, Room ${course.room}</small>
                        `;
                        resultElement.addEventListener('click', () => {
                            const target = new google.maps.LatLng(building.lat, building.lng);
                            centerAndPulse(target, `${building.title}, Room ${course.room}`);
                            document.getElementById('room-search').value = course.code;
                            selectedBuilding = building;
                            showDirectionsPanel();
                        });
                        roomResults.appendChild(resultElement);
                    }
                });
            }
        }

        function centerAndPulse(position, title) {
            map.panTo(position);
            map.setZoom(18);
            
            // Pulse animation
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                animation: google.maps.Animation.BOUNCE,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: "#FFD700",
                    fillOpacity: 0.8,
                    strokeColor: "#FFFFFF",
                    strokeWeight: 3,
                    scale: 10,
                    optimized: true
                },
                zIndex: google.maps.Marker.MAX_ZINDEX + 2
            });
            
            setTimeout(() => marker.setMap(null), 1400);
        }

        function showBuildingInfo(building) {
            selectedBuilding = building;
            
            // Create info window content
            const content = `
                <div style="max-width:250px">
                    <h3 style="margin:0 0 5px 0;color:#00509E">${building.title}</h3>
                    <p>${building.category} Building</p>
                    ${building.accessibility.wheelchair ? '<p>♿ Wheelchair accessible</p>' : ''}
                    ${building.accessibility.elevator ? '<p>🛗 Elevator available</p>' : ''}
                    <button onclick="window.showDirectionsFromHere(${building.lat},${building.lng})" 
                            style="background:#00509E;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:5px">
                        Get Directions
                    </button>
                </div>
            `;
            
            // Create and open info window
            const infoWindow = new google.maps.InfoWindow({
                content: content
            });
            
            infoWindow.open(map, new google.maps.Marker({
                position: { lat: building.lat, lng: building.lng },
                map: map
            }));
        }

        // Make this function available globally
        window.showDirectionsFromHere = function(lat, lng) {
            if (userLocationMarker) {
                calculateAndDisplayRoute({ lat, lng }, 'WALKING');
            } else {
                alert("Please enable your location first");
            }
        };

        function showDirectionsPanel() {
            document.getElementById('directions-panel').style.display = 'block';
            document.getElementById('reset-directions').style.display = 'block';
            
            if (userLocationMarker) {
                calculateAndDisplayRoute(selectedBuilding, 'WALKING');
            } else {
                document.getElementById('directions-instructions').innerHTML = 
                    '<p>Enable location services to get directions from your current position.</p>';
            }
        }

        function calculateAndDisplayRoute(destination, mode) {
            if (!userLocationMarker) return;

            const request = {
                origin: userLocationMarker.getPosition(),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode[mode],
                provideRouteAlternatives: true
            };

            // Add accessibility options if enabled
            if (currentScenario === 'accessibility') {
                request.travelOptions = {
                    routingPreference: 'WHEELCHAIR_ACCESSIBLE'
                };
            }

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Display distance and instructions
                    const route = result.routes[0].legs[0];
                    document.getElementById('distance-info').innerHTML = 
                        `<p><strong>Distance:</strong> ${route.distance.text}<br>
                         <strong>Duration:</strong> ${route.duration.text}</p>`;
                    
                    let instructions = '<ol>';
                    route.steps.forEach(step => {
                        instructions += `<li>${step.instructions}</li>`;
                    });
                    instructions += '</ol>';
                    document.getElementById('directions-instructions').innerHTML = instructions;
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        function resetDirections() {
            directionsRenderer.setMap(null);
            document.getElementById('directions-panel').style.display = 'none';
            document.getElementById('reset-directions').style.display = 'none';
            selectedBuilding = null;
        }

        function resetMap() {
            const bounds = new google.maps.LatLngBounds();
            BOUNDARY_COORDS.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds);
            resetDirections();
        }

        function getUserLocation(centerOnUser) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Check if within campus bounds
                        const bounds = new google.maps.LatLngBounds();
                        BOUNDARY_COORDS.forEach(coord => bounds.extend(coord));
                        
                        if (!bounds.contains(pos) && !centerOnUser) {
                            updateDebugInfo("You appear to be outside campus boundaries");
                            return;
                        }

                        // Remove old marker if exists
                        if (userLocationMarker) {
                            userLocationMarker.setMap(null);
                        }

                        // Create new marker
                        userLocationMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: "Your Location",
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                                scaledSize: new google.maps.Size(32, 32)
                            },
                            zIndex: google.maps.Marker.MAX_ZINDEX + 3
                        });

                        if (centerOnUser) {
                            map.panTo(pos);
                            map.setZoom(18);
                        }
                    },
                    (error) => {
                        let errorMessage = "Error getting location: ";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += "Location permission denied";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += "Location unavailable";
                                break;
                            case error.TIMEOUT:
                                errorMessage += "Location request timed out";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage += "Unknown error";
                                break;
                        }
                        updateDebugInfo(errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateDebugInfo("Geolocation not supported by this browser");
            }
        }

        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            debugElement.textContent = message;
            debugElement.style.display = 'block';
            setTimeout(() => {
                debugElement.style.display = 'none';
            }, 5000);
        }
    </script>
    <script>
        // Load Google Maps API with proper async pattern
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyA0eo_kH5S8DCX53vLaILohfuo0-nkwqQc&libraries=places&callback=initMap';
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                document.getElementById('map').innerHTML = 
                    '<div style="padding:20px;color:red">Failed to load Google Maps. Please check your internet connection.</div>';
            };
            document.head.appendChild(script);
        }
        
        // Start loading the map when page loads
        window.onload = loadGoogleMaps;
    </script>
</body>
</html>
