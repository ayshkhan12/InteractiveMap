<!DOCTYPE html>
<html>
<head>
    <title>Interactive University of Hull Map</title>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            background: rgba(255,255,255,0.98);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            width: 280px;
            font-family: Arial, sans-serif;
            max-height: 90vh;
            overflow-y: auto;
        }
        #search-container {
            margin-bottom: 15px;
        }
        #search-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            display: none;
        }
        #directions-panel {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            display: none;
        }
        .category {
            color: #00509E;
            font-weight: bold;
            margin: 15px 0 5px 0;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        button:hover {
            background: #00509E;
            color: white;
        }
        #logo {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #00509E;
            font-size: 1.1em;
        }
        #recenter-btn, #reset-directions, #show-location, #toggle-satellite {
            background: #00509E;
            color: white;
            text-align: center;
        }
        .search-result {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-result:hover {
            background: #f0f7ff;
        }
        .mode-selector {
            margin: 10px 0;
        }
        .mode-btn {
            display: inline-block;
            width: auto;
            padding: 5px 10px;
            margin-right: 5px;
        }
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            display: none;
        }
        .building-label {
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 3px #000;
            padding: 2px 5px;
            background-color: rgba(0, 80, 158, 0.7);
            border-radius: 3px;
        }
        /* New styles for mode panels */
        .mode-toggle {
            background: #00509E;
            color: white;
            text-align: center;
            margin: 5px 0;
        }
        .mode-panel {
            padding: 10px;
            background: #f0f7ff;
            border-radius: 6px;
            margin: 10px 0;
        }
        .mode-panel label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
        }
        #emergency-call {
            background: #ff0000;
            color: white;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        /* Accessibility route styling */
        .accessibility-route {
            stroke-color: #2ECC71;
            stroke-width: 6;
            stroke-opacity: 0.8;
        }
        /* Event marker styling */
        .event-marker {
            fillColor: "#9B59B6";
            fillOpacity: 0.9;
            strokeColor: "#FFFFFF";
            strokeWeight: 2;
            scale: 8;
        }
        /* Parking marker styling */
        .parking-marker {
            fillColor: "#34495E";
            fillOpacity: 0.9;
            strokeColor: "#FFFFFF";
            strokeWeight: 2;
            scale: 8;
        }
        /* Alert banner */
        #alert-banner {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,204,0,0.9);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10;
            display: none;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="alert-banner"></div>
    <div id="controls">
        <div id="logo">UNIVERSITY OF HULL</div>
        
        <!-- Search Box -->
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search buildings...">
            <div id="search-results"></div>
        </div>
        
        <button id="recenter-btn">Reset View</button>
        <button id="show-location">Show My Location</button>
        <button id="toggle-satellite">Toggle Satellite View</button>
        <button id="reset-directions" style="display:none;">Clear Directions</button>
        
        <!-- Directions Panel -->
        <div id="directions-panel">
            <div class="mode-selector">
                <button class="mode-btn" data-mode="WALKING">Walk</button>
                <button class="mode-btn" data-mode="DRIVING">Drive</button>
            </div>
            <div id="directions-instructions"></div>
            <div id="distance-info"></div>
        </div>
        
        <!-- New Mode Selection -->
        <div class="category">NAVIGATION MODES</div>
        <button id="study-mode-btn" class="mode-toggle">Study Mode</button>
        <button id="accessibility-mode-btn" class="mode-toggle">Accessibility</button>
        <button id="emergency-mode-btn" class="mode-toggle">Emergency</button>
        <button id="events-mode-btn" class="mode-toggle">Events</button>
        <button id="parking-mode-btn" class="mode-toggle">Parking</button>

        <!-- Study Mode Panel -->
        <div id="study-panel" class="mode-panel" style="display:none;">
            <input type="text" id="room-search" placeholder="Enter room code (e.g. LB101)">
            <div id="room-results"></div>
        </div>

        <!-- Accessibility Options Panel -->
        <div id="accessibility-panel" class="mode-panel" style="display:none;">
            <label>
                <input type="checkbox" id="wheelchair-route" checked> 
                Wheelchair accessible routes only
            </label>
            <label>
                <input type="checkbox" id="avoid-stairs" checked> 
                Avoid stairs
            </label>
        </div>

        <!-- Emergency Panel -->
        <div id="emergency-panel" class="mode-panel" style="display:none;">
            <button id="find-security">Find Security Office</button>
            <button id="find-medical">Find Medical Help</button>
            <button id="emergency-call">Call Campus Security</button>
        </div>

        <!-- Events Panel -->
        <div id="events-panel" class="mode-panel" style="display:none;">
            <div id="events-list"></div>
            <label>
                <input type="checkbox" id="show-future-events" checked>
                Show upcoming events
            </label>
        </div>

        <!-- Parking Panel -->
        <div id="parking-panel" class="mode-panel" style="display:none;">
            <div id="parking-info">Loading parking availability...</div>
            <label>
                <input type="checkbox" id="accessible-parking" checked>
                Show accessible parking only
            </label>
        </div>
        
        <!-- Building Categories -->
        <div class="category">ACADEMIC BUILDINGS</div>
        <button class="goto-btn" data-lat="53.771112" data-lng="-0.369320">Brynmor Jones Library</button>
        <button class="goto-btn" data-lat="53.770998" data-lng="-0.370300">Allam Medical Building</button>
        <button class="goto-btn" data-lat="53.770821" data-lng="-0.366477">Wilberforce Building</button>
        <button class="goto-btn" data-lat="53.770330" data-lng="-0.368166">Larkin Building</button>
        <button class="goto-btn" data-lat="53.771509" data-lng="-0.368860">Robert Blackburn</button>
        
        <div class="category">STUDENT LIFE</div>
        <button class="goto-btn" data-lat="53.772666" data-lng="-0.365194">Masjid Hull University</button>
        <button class="goto-btn" data-lat="53.771961" data-lng="-0.366254">Student Union (Asylum)</button>
        <button class="goto-btn" data-lat="53.771715" data-lng="-0.366143">Wetherspoons (Sanctuary)</button>
        
        <div class="category">ACCOMMODATIONS</div>
        <button class="goto-btn" data-lat="53.772658" data-lng="-0.366401">The Courtyard</button>
        <button class="goto-btn" data-lat="53.771534" data-lng="-0.372415">Westfield Court</button>
        <button class="goto-btn" data-lat="53.770757" data-lng="-0.364416">Taylor Court</button>
        
        <div class="category">SPORTS</div>
        <button class="goto-btn" data-lat="53.774024" data-lng="-0.368526">Allam Sports Centre</button>
    </div>

    <div id="debug-info"></div>

    <script>
        // Boundary coordinates (invisible crop)
        const BOUNDARY_COORDS = [
            { lat: 53.776447, lng: -0.371282 }, // NW
            { lat: 53.772511, lng: -0.374911 }, // NE
            { lat: 53.769470, lng: -0.371443 }, // SE
            { lat: 53.769553, lng: -0.366529 }, // SW
            { lat: 53.770662, lng: -0.362849 }, // Additional
            { lat: 53.776204, lng: -0.365295 }  // Additional
        ];

        let map;
        let directionsService;
        let directionsRenderer;
        let userLocationMarker;
        let selectedBuilding = null;
        let isSatelliteView = false;
        let currentMode = null;
        let accessibilityOptions = {
            wheelchair: true,
            avoidStairs: true
        };
        let eventMarkers = [];
        let parkingMarkers = [];
        let teacherAlerts = [];

        // Enhanced buildings data
        const BUILDINGS = [
            {
                id: "LIB-01",
                title: "Brynmor Jones Library",
                lat: 53.771112,
                lng: -0.369320,
                color: "#00509E",
                category: "Academic",
                accessibility: {
                    wheelchair: true,
                    elevator: true,
                    accessibleRestrooms: true
                },
                rooms: ["LB101", "LB202", "LB305"],
                emergency: {
                    isFirstAidCenter: false,
                    hasEmergencyPhone: true
                }
            },
            // ... (rest of your buildings data)
        ];

        // Emergency facilities data
        const EMERGENCY_FACILITIES = [
            {
                id: "SEC-01",
                title: "Security Office",
                lat: 53.771500,
                lng: -0.368500,
                type: "security"
            },
            {
                id: "FIR-01",
                title: "First Aid Station",
                lat: 53.770998,
                lng: -0.370300,
                type: "medical"
            }
        ];

        // Events data
        const EVENTS = [
            {
                id: "EVT-001",
                title: "Freshers' Welcome",
                buildingId: "LIB-01",
                start: "2023-09-20T10:00:00",
                end: "2023-09-20T16:00:00",
                description: "Welcome event for new students",
                category: "social"
            },
            {
                id: "EVT-002",
                title: "Computer Science Lecture",
                buildingId: "WIL-01",
                start: "2023-09-21T09:00:00",
                end: "2023-09-21T11:00:00",
                description: "Intro to Programming",
                category: "academic"
            }
        ];

        // Parking data
        const PARKING_LOTS = [
            {
                id: "PARK-01",
                title: "Main Campus Parking",
                lat: 53.772000,
                lng: -0.370000,
                totalSpaces: 120,
                availableSpaces: 45,
                accessibleSpaces: 8,
                accessibleAvailable: 3
            }
        ];

        // Teacher alerts (would normally come from a server)
        const TEACHER_ALERTS = [
            {
                id: "ALERT-001",
                buildingId: "WIL-01",
                room: "WB101",
                message: "CS101 moved to Larkin Building Room LK205 today",
                expires: "2023-09-21T17:00:00"
            }
        ];

        function initMap() {
            // Initialize map with strict boundaries
            const bounds = new google.maps.LatLngBounds();
            BOUNDARY_COORDS.forEach(coord => bounds.extend(coord));

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 53.771, lng: -0.368 },
                zoom: 17,
                mapTypeId: 'hybrid',
                disableDefaultUI: true,
                gestureHandling: "greedy",
                restriction: {
                    latLngBounds: bounds,
                    strictBounds: true
                }
            });

            // Add invisible cropping polygon
            new google.maps.Polygon({
                paths: BOUNDARY_COORDS,
                strokeOpacity: 0,
                fillOpacity: 0,
                map: map
            });

            // Initialize directions services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                preserveViewport: true,
                polylineOptions: {
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.8,
                    strokeWeight: 5
                }
            });

            // Add building markers
            BUILDINGS.forEach(location => {
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.title,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: location.color,
                        fillOpacity: 0.9,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2,
                        scale: 8,
                        optimized: true
                    },
                    zIndex: google.maps.Marker.MAX_ZINDEX + 1
                });

                // Add building labels
                const label = new google.maps.InfoWindow({
                    content: `<div class="building-label">${location.title}</div>`,
                    disableAutoPan: true
                });
                
                marker.addListener("mouseover", () => {
                    label.open(map, marker);
                });
                
                marker.addListener("mouseout", () => {
                    label.close();
                });

                marker.addListener("click", () => {
                    showBuildingInfo(location);
                });
            });

            // Add emergency facility markers
            EMERGENCY_FACILITIES.forEach(facility => {
                new google.maps.Marker({
                    position: { lat: facility.lat, lng: facility.lng },
                    map: map,
                    title: facility.title,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: "#FF0000",
                        fillOpacity: 0.9,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2,
                        scale: 8
                    },
                    zIndex: google.maps.Marker.MAX_ZINDEX + 2
                });
            });

            // Initialize event markers (initially hidden)
            initializeEvents();
            
            // Initialize parking markers (initially hidden)
            initializeParking();

            // Check for teacher alerts
            checkTeacherAlerts();

            // Set up event listeners
            setupEventListeners();

            // Initial location attempt
            getUserLocation(false);
        }

        function setupEventListeners() {
            // Existing event listeners...
            document.getElementById('study-mode-btn').addEventListener('click', toggleStudyMode);
            document.getElementById('accessibility-mode-btn').addEventListener('click', toggleAccessibilityMode);
            document.getElementById('emergency-mode-btn').addEventListener('click', toggleEmergencyMode);
            document.getElementById('events-mode-btn').addEventListener('click', toggleEventsMode);
            document.getElementById('parking-mode-btn').addEventListener('click', toggleParkingMode);
            
            document.getElementById('wheelchair-route').addEventListener('change', updateAccessibilityOptions);
            document.getElementById('avoid-stairs').addEventListener('change', updateAccessibilityOptions);
            document.getElementById('find-security').addEventListener('click', findSecurity);
            document.getElementById('find-medical').addEventListener('click', findMedical);
            document.getElementById('emergency-call').addEventListener('click', callSecurity);
            document.getElementById('room-search').addEventListener('input', searchRooms);
            document.getElementById('show-future-events').addEventListener('change', updateEventsDisplay);
            document.getElementById('accessible-parking').addEventListener('change', updateParkingDisplay);
        }

        function initializeEvents() {
            EVENTS.forEach(event => {
                const building = BUILDINGS.find(b => b.id === event.buildingId);
                if (building) {
                    const marker = new google.maps.Marker({
                        position: { lat: building.lat, lng: building.lng },
                        map: null, // Initially not shown
                        title: event.title,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: "#9B59B6",
                            fillOpacity: 0.9,
                            strokeColor: "#FFFFFF",
                            strokeWeight: 2,
                            scale: 8
                        },
                        zIndex: google.maps.Marker.MAX_ZINDEX + 3
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="max-width:250px">
                                <h3 style="margin:0 0 5px 0;color:#9B59B6">${event.title}</h3>
                                <p><strong>Location:</strong> ${building.title}</p>
                                <p><strong>Time:</strong> ${formatEventTime(event.start, event.end)}</p>
                                <p>${event.description}</p>
                            </div>
                        `
                    });
                    
                    marker.addListener("click", () => {
                        infoWindow.open(map, marker);
                    });
                    
                    eventMarkers.push({
                        marker: marker,
                        event: event
                    });
                }
            });
            updateEventsList();
        }

        function initializeParking() {
            PARKING_LOTS.forEach(lot => {
                const marker = new google.maps.Marker({
                    position: { lat: lot.lat, lng: lot.lng },
                    map: null, // Initially not shown
                    title: lot.title,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: "#34495E",
                        fillOpacity: 0.9,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2,
                        scale: 8
                    },
                    zIndex: google.maps.Marker.MAX_ZINDEX + 2
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="max-width:250px">
                            <h3 style="margin:0 0 5px 0;color:#34495E">${lot.title}</h3>
                            <p><strong>Available spaces:</strong> ${lot.availableSpaces}/${lot.totalSpaces}</p>
                            <p><strong>Accessible spaces:</strong> ${lot.accessibleAvailable}/${lot.accessibleSpaces}</p>
                        </div>
                    `
                });
                
                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });
                
                parkingMarkers.push({
                    marker: marker,
                    lot: lot
                });
            });
            updateParkingInfo();
        }

        function checkTeacherAlerts() {
            const now = new Date();
            teacherAlerts = TEACHER_ALERTS.filter(alert => new Date(alert.expires) > now);
            
            if (teacherAlerts.length > 0) {
                showAlertBanner(teacherAlerts[0].message);
                
                // Highlight affected buildings
                teacherAlerts.forEach(alert => {
                    const building = BUILDINGS.find(b => b.id === alert.buildingId);
                    if (building) {
                        // Add pulsing alert marker
                        const alertMarker = new google.maps.Marker({
                            position: { lat: building.lat, lng: building.lng },
                            map: map,
                            title: "Class Change Alert",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: "#FFA500",
                                fillOpacity: 0.8,
                                strokeColor: "#FFFFFF",
                                strokeWeight: 2,
                                scale: 10
                            },
                            zIndex: google.maps.Marker.MAX_ZINDEX + 4,
                            animation: google.maps.Animation.BOUNCE
                        });
                        
                        // Remove after 10 seconds
                        setTimeout(() => {
                            alertMarker.setMap(null);
                        }, 10000);
                    }
                });
            }
        }

        function showAlertBanner(message) {
            const banner = document.getElementById('alert-banner');
            banner.textContent = message;
            banner.style.display = 'block';
            
            // Hide after 15 seconds
            setTimeout(() => {
                banner.style.display = 'none';
            }, 15000);
        }

        function toggleStudyMode() {
            if (currentMode === 'study') {
                currentMode = null;
                document.getElementById('study-panel').style.display = 'none';
                document.getElementById('study-mode-btn').style.backgroundColor = '#00509E';
            } else {
                currentMode = 'study';
                document.getElementById('study-panel').style.display = 'block';
                document.getElementById('study-mode-btn').style.backgroundColor = '#003366';
                // Hide other panels
                hideAllPanelsExcept('study-panel');
                // Reset other mode buttons
                resetModeButtonsExcept('study-mode-btn');
            }
        }

        function toggleAccessibilityMode() {
            if (currentMode === 'accessibility') {
                currentMode = null;
                document.getElementById('accessibility-panel').style.display = 'none';
                document.getElementById('accessibility-mode-btn').style.backgroundColor = '#00509E';
            } else {
                currentMode = 'accessibility';
                document.getElementById('accessibility-panel').style.display = 'block';
                document.getElementById('accessibility-mode-btn').style.backgroundColor = '#003366';
                // Hide other panels
                hideAllPanelsExcept('accessibility-panel');
                // Reset other mode buttons
                resetModeButtonsExcept('accessibility-mode-btn');
            }
        }

        function toggleEmergencyMode() {
            if (currentMode === 'emergency') {
                currentMode = null;
                document.getElementById('emergency-panel').style.display = 'none';
                document.getElementById('emergency-mode-btn').style.backgroundColor = '#00509E';
            } else {
                currentMode = 'emergency';
                document.getElementById('emergency-panel').style.display = 'block';
                document.getElementById('emergency-mode-btn').style.backgroundColor = '#003366';
                // Hide other panels
                hideAllPanelsExcept('emergency-panel');
                // Reset other mode buttons
                resetModeButtonsExcept('emergency-mode-btn');
            }
        }

        function toggleEventsMode() {
            if (currentMode === 'events') {
                currentMode = null;
                document.getElementById('events-panel').style.display = 'none';
                document.getElementById('events-mode-btn').style.backgroundColor = '#00509E';
                hideEventMarkers();
            } else {
                currentMode = 'events';
                document.getElementById('events-panel').style.display = 'block';
                document.getElementById('events-mode-btn').style.backgroundColor = '#003366';
                // Hide other panels
                hideAllPanelsExcept('events-panel');
                // Reset other mode buttons
                resetModeButtonsExcept('events-mode-btn');
                showEventMarkers();
            }
        }

        function toggleParkingMode() {
            if (currentMode === 'parking') {
                currentMode = null;
                document.getElementById('parking-panel').style.display = 'none';
                document.getElementById('parking-mode-btn').style.backgroundColor = '#00509E';
                hideParkingMarkers();
            } else {
                currentMode = 'parking';
                document.getElementById('parking-panel').style.display = 'block';
                document.getElementById('parking-mode-btn').style.backgroundColor = '#003366';
                // Hide other panels
                hideAllPanelsExcept('parking-panel');
                // Reset other mode buttons
                resetModeButtonsExcept('parking-mode-btn');
                showParkingMarkers();
            }
        }

        function hideAllPanelsExcept(panelId) {
            const panels = ['study-panel', 'accessibility-panel', 'emergency-panel', 'events-panel', 'parking-panel'];
            panels.forEach(id => {
                if (id !== panelId) {
                    document.getElementById(id).style.display = 'none';
                }
            });
        }

        function resetModeButtonsExcept(buttonId) {
            const buttons = ['study-mode-btn', 'accessibility-mode-btn', 'emergency-mode-btn', 'events-mode-btn', 'parking-mode-btn'];
            buttons.forEach(id => {
                if (id !== buttonId) {
                    document.getElementById(id).style.backgroundColor = '#00509E';
                }
            });
        }

        function showEventMarkers() {
            const showFuture = document.getElementById('show-future-events').checked;
            const now = new Date();
            
            eventMarkers.forEach(eventMarker => {
                const eventEnd = new Date(eventMarker.event.end);
                if (showFuture || eventEnd > now) {
                    eventMarker.marker.setMap(map);
                } else {
                    eventMarker.marker.setMap(null);
                }
            });
        }

        function hideEventMarkers() {
            eventMarkers.forEach(eventMarker => {
                eventMarker.marker.setMap(null);
            });
        }

        function showParkingMarkers() {
            const showAccessibleOnly = document.getElementById('accessible-parking').checked;
            
            parkingMarkers.forEach(parkingMarker => {
                if (!showAccessibleOnly || parkingMarker.lot.accessibleAvailable > 0) {
                    parkingMarker.marker.setMap(map);
                } else {
                    parkingMarker.marker.setMap(null);
                }
            });
        }

        function hideParkingMarkers() {
            parkingMarkers.forEach(parkingMarker => {
                parkingMarker.marker.setMap(null);
            });
        }

        function updateEventsList() {
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = '';
            
            const now = new Date();
            const showFuture = document.getElementById('show-future-events').checked;
            
            eventMarkers
                .filter(eventMarker => showFuture || new Date(eventMarker.event.end) > now)
                .sort((a, b) => new Date(a.event.start) - new Date(b.event.start))
                .forEach(eventMarker => {
                    const event = eventMarker.event;
                    const building = BUILDINGS.find(b => b.id === event.buildingId);
                    
                    const eventElement = document.createElement('div');
                    eventElement.className = 'search-result';
                    eventElement.innerHTML = `
                        <strong>${event.title}</strong><br>
                        <small>${formatEventTime(event.start, event.end)}</small><br>
                        <small>${building ? building.title : ''}</small>
                    `;
                    
                    eventElement.addEventListener('click', () => {
                        if (building) {
                            centerAndPulse(
                                { lat: building.lat, lng: building.lng },
                                `${event.title} at ${building.title}`
                            );
                        }
                    });
                    
                    eventsList.appendChild(eventElement);
                });
        }

        function updateParkingInfo() {
            const parkingInfo = document.getElementById('parking-info');
            let available = 0;
            let total = 0;
            let accessibleAvailable = 0;
            let accessibleTotal = 0;
            
            parkingMarkers.forEach(parkingMarker => {
                available += parkingMarker.lot.availableSpaces;
                total += parkingMarker.lot.totalSpaces;
                accessibleAvailable += parkingMarker.lot.accessibleAvailable;
                accessibleTotal += parkingMarker.lot.accessibleSpaces;
            });
            
            parkingInfo.innerHTML = `
                <p><strong>Total available:</strong> ${available}/${total} spaces</p>
                <p><strong>Accessible spaces:</strong> ${accessibleAvailable}/${accessibleTotal}</p>
            `;
        }

        function updateEventsDisplay() {
            if (currentMode === 'events') {
                showEventMarkers();
                updateEventsList();
            }
        }

        function updateParkingDisplay() {
            if (currentMode === 'parking') {
                showParkingMarkers();
            }
        }

        function formatEventTime(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            
            // Format as "Day, HH:MM - HH:MM"
            const options = { 
                weekday: 'short', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            };
            
            const startStr = startDate.toLocaleTimeString('en-GB', options);
            const endStr = endDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            return `${startStr} - ${endStr}`;
        }

        // ... (keep all your existing functions like getUserLocation, calculateAndDisplayRoute, etc.)
        // Make sure to include all the functions from your original code that I haven't shown here

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA0eo_kH5S8DCX53vLaILohfuo0-nkwqQc&callback=initMap&libraries=places" async defer></script>
</body>
</html>
